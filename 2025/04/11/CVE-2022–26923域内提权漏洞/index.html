<!DOCTYPE html>
<html lang="en">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>CVE-2022–26923域内提权漏洞 - Chromos2me&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.jpg">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="CVE-2022–26923域内提权漏洞 - Chromos2me&#39;s Blog" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://chromos2me.github.io/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2025-04-11T08:57:24.000Z" />
  
  <meta property="og:article:author" content="Chromos2me" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 7.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="always"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Chromos2me&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item" href="/tags">Tags</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/Chromos2me" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/域渗透/">域渗透</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>April</span>
            <span>11,</span>
            <span>2025</span>
        </div>
        

        <h1 class="title">CVE-2022–26923域内提权漏洞</h1>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h2 id="分析前准备"><a href="#分析前准备" class="headerlink" title="分析前准备"></a>分析前准备</h2><p>这里我已经在我自己搭建的域控上创建了一个名为<code>robert</code>的用户，利用Certipy在AD中利用申请的证书模板进行身份验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">certipy-ad req -u <span class="string">&#x27;robert&#x27;</span> -p <span class="string">&#x27;Passw0rd&#x27;</span> -ca MY-DC-CA -template User -target 192.168.103.201</span><br><span class="line"></span><br><span class="line">certipy-ad auth -pfx chromos2me.pfx -dc-ip 192.168.103.201</span><br></pre></td></tr></table></figure>
<p>在默认情况下，域用户可以向证书颁发机构申请注册User证书模板，域计算机可以申请注册Machine证书</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250408214215.png" alt="微信截图_20250408214215"></p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250408214242.png" alt="微信截图_20250408214242"></p>
<p>利用impacket工具包创建一个机器账户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-addcomputer <span class="string">&#x27;chromos2me.com/robert:Passw0rd&#x27;</span> -computer-name <span class="string">&#x27;ROBERTPC&#x27;</span> -computer-pass <span class="string">&#x27;Passw0rd&#x27;</span> -dc-ip 192.168.103.201 </span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250408213958.png" alt="微信截图_20250408213958"></p>
<p>新创建的机器账户不存在<code>dNSHostName</code>属性，我们通过<code>bloodyAD</code>为机器账户创建<code>dNSHostName</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 bloodyAD.py -d chromos2me.com -u robert -p Passw0rd --host 192.168.103.201 <span class="built_in">set</span> object <span class="string">&#x27;CN=ROBERTPC,CN=Computers,DC=Chromos2me,DC=com&#x27;</span> dNSHostName -v <span class="string">&#x27;robertpc.chromos2me.com&#x27;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>其实也可以通过<code>impacket-addcomputer</code>中的 <code>-computer-name</code>参数进行添加，但是我的机器上会显示成功添加，我在域控上查看的时候<code>dNSHostName</code>并没有成功添加</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410120232.png" alt="微信截图_20250410120232"></p>
</blockquote>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250408221111.png" alt="微信截图_20250408221111"></p>
<p>获取<code>Machine</code>证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy-ad req -u <span class="string">&#x27;robertpc$&#x27;</span> -p <span class="string">&#x27;Passw0rd&#x27;</span> -ca MY-DC-CA -template Machine -dc-ip 192.168.103.201</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250408232307.png" alt="微信截图_20250408232307"></p>
<p>进行身份验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy-ad auth -pfx robertpc.pfx -dc-ip 192.168.103.201</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250408232237.png" alt="微信截图_20250408232237"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>一般来说两个证书的EKU（Extended Key Usage）这个拓展的证书字段均支持<strong>Client Authentication</strong>，这个EKU说明颁发的证书可以通过公钥加密（ Public Key Cryptography for Initial Authentication (PKINIT)）进行Kerberos协议的初始身份验证</p>
<p>为什么ADCS需要给域用户和域内机器账户提供不同的证书模板？</p>
<p>这里我们利用ly4k写的<a target="_blank" rel="noopener" href="https://github.com/ly4k/BloodHound">支持PKI版本的Bloodhound</a>去看一下每一张证书的标志位，探究一下不同的账户是如何进行身份验证获取证书</p>
<p>首先是User证书</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250409173634.png" alt="微信截图_20250409173634"></p>
<p><strong>域用户通过UPN唯一标识自己</strong>，我们可以看到证书的Certificate Name Flag字段存在标志位<code>SubjectAltRequireUpn</code>，在微软官方的文档中记录为<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/1192823c-d839-4bc3-9b6b-fa8c53507ae1">CT_FLAG_SUBJECT_ALT_REQUIRE_UPN</a>，此标志指示CA将请求者在AD中用户对象的 UPN （User Principal Name 即我们所说的UPN用户主体名称）属性值添加到颁发证书的主题备用名称（Subject Alternative Name，SAN）扩展中，同时根据微软官方<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/3c154285-454c-4353-9a99-fb586e806944">3.1.1.5.1.3 Uniqueness Constraints</a>规定，我们的域内不能存在两个UPN相同的账户，我们可以新建一个用户并将其UPN更改为我们的robert用户的UPN，看看会发生什么</p>
<p>如下图所示，出现了域内一致UPN的冲突</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250409180019.png" alt="微信截图_20250409180019"></p>
<p>我们接下来回到Machine证书模板，探究一下机器账户是如何进行身份验证的</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250409180704.png" alt="微信截图_20250409180704"></p>
<p>我们可以看到标志位中存在<code>SubjectAltRequireDns</code>，在微软文档中记录为<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-crtd/1192823c-d839-4bc3-9b6b-fa8c53507ae1">CT_FLAG_SUBJECT_ALT_REQUIRE_DNS</a>，此标志指示证书颁发机构CA将从请求者在AD中用户对象的DNS属性获得的值添加到颁发证书的SAN扩展中，我们将刚才申请机器账户证书的截图再拿出来一下</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250408232307new.png" alt="微信截图_20250408232307new"></p>
<p>从上图我圈出的地方可以看到，CA通过DNS主机名对机器账户进行验证，我们在AD Explore中看一下这个属性在哪里被定义</p>
<p>如下图所示<code>dNSHostName</code>中对DNS主机名进行了定义</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250409182726.png" alt="微信截图_20250409182726"></p>
<p>那么我们能否对其进行修改呢？这里我们需要查看一下<code>robertpc</code>的安全属性，同时<code>robertpc</code>这个机器账户是我们通过<code>robert</code>这个账户进行创建的，我们只观察<code>robert</code>拥有的权限</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250409183220.png" alt="微信截图_20250409183220"></p>
<p>关于已验证的到DNS主机名的写入权限的详细解释在<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/adschema/r-validated-dns-host-name">Validated-DNS-Host-Name validated writes</a>，简单来说这个权限允许设置与计算机名和域名一致的<code>dNSHostName</code> 属性，似乎有点难以理解，我们接着做一个实验，我们尝试修改<code>dNSHostName</code>为<code>mytest.chromos2me.com</code>看看会发生什么</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250409184524.png" alt="微信截图_20250409184524"></p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250409184544.png" alt="微信截图_20250409184544"></p>
<p>如上图所示被成功修改，同时注意到<code>sAMAccountName</code>并未被修改</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250409184619.png" alt="微信截图_20250409184619"></p>
<blockquote>
<p>这里的与计算机名和域名一致的<code>dNSHostName</code> 属性实际上只要我们设置的合理一般都不会出现非法写入</p>
</blockquote>
<p>现在能否能利用机器账户进行证书的请求？试试就知道了</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250409185008.png" alt="微信截图_20250409185008"></p>
<p>很明显我们成功利用新的DNS主机名标识了我们的机器同时进行了证书的申请，这里我们可以进行一个思考，我们在上文提到的Uniqueness Constraints唯一性约束文档中并未提到机器账户的dNSHostName必须唯一，那么能否修改dNSHostName为和域控一样，那么我们是不是就能利用域控身份进行高权限证书的请求呢？</p>
<p>这里因为impacket下的addcomputer在使用默认的SAMR方法创建机器账户时不会包含SPN属性，同时因为我自己的环境问题无法换用LDAPS方法，这里我们就手动的利用<a target="_blank" rel="noopener" href="https://github.com/dirkjanm/krbrelayx">krbrelayx</a>中的addspn这个工具进行添加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 addspn.py -u chromos2me.com\\robertpc\$ -p Passw0rd -s HOST/robertpc.chromos2me.com 192.168.103.201</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410133430.png" alt="微信截图_20250410133430"></p>
<p>查询一下SPN</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 addspn.py -u chromos2me.com\\robertpc\$ -p Passw0rd 192.168.103.201 -q</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410133523.png" alt="微信截图_20250410133523"></p>
<p>根据<a target="_blank" rel="noopener" href="https://learn.microsoft.com/zh-cn/windows-server/identity/ad-ds/manage/how-to-configure-spn?tabs=add%2Caduc">How to configure SPN</a>微软官方文档所指出的SPN格式</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TERMSRV/WSRV2022</span><br><span class="line">TERMSRV/WSRV2022.contoso1.com</span><br></pre></td></tr></table></figure>
<p>我们为了复现漏洞环境在域控上添加一条关于主机名的SPN</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">HOST/robertpc</span><br><span class="line">RestrictedKrbHost/robertpc</span><br><span class="line">RestrictedKrbHost/robertpc.chromos2me.com</span><br></pre></td></tr></table></figure>
<blockquote>
<p>实际上在我们刚才使用<code>addspn</code>添加SPN时工具自动创建的SPN格式为</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;KrbRestrictedHost/hostname</span><br><span class="line">&gt;KrbRestrictedHost/hostname.domain<span class="emphasis">_fqdn</span></span><br><span class="line"><span class="emphasis">&gt;Host/hostname</span></span><br><span class="line"><span class="emphasis">&gt;Host/hostname.domain_</span>fqdn</span><br></pre></td></tr></table></figure>
<p>但是似乎环境存在问题，所以尝试手动复现一下环境，这里可以参考<code>impacket-addcomputer</code>中关于创建SPN的代码添加</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410134717.png" alt="微信截图_20250410134717"></p>
</blockquote>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410134916.png" alt="微信截图_20250410134916"></p>
<p>在域控组织单元中找到<code>DC$</code>的<code>dNSHostName</code></p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250409185522.png" alt="微信截图_20250409185522"></p>
<p>对<code>robertpc$</code>的<code>dNSHostName</code>修改为域控的<code>dNSHostName</code>看看会发生什么</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410154902.png" alt="微信截图_20250410154902"></p>
<p>点击OK后出现了操作错误</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410155052.png" alt="微信截图_20250410155052"></p>
<p>为了追究其原因我们尝试将DNS主机名修改为DC之外的主机名，然后观察一下SPN的变化</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410155520.png" alt="微信截图_20250410155520"></p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410155551.png" alt="微信截图_20250410155551"></p>
<p>由上图发现，<code>dNSHostName</code>发生变化时，SPN中与FQDN完整限定域名有关的项均发生了改变，可以想象到，当我们将创建的机器账户<code>robertpc$</code> 的<code>dNSHostName</code>更改为<code>DC.chromos2me.com</code>时其SPN会变为<code>RestrictedKrbHost/DC.chromos2me.com</code> 和 <code>HOST/DC.chromos2me.com</code>，这样就会与域控的SPN发生唯一性约束冲突，我们可以看一下域控的SPN属性</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410162256.png" alt="微信截图_20250410162256"></p>
<p>到现在为止，我们已经确定了操作错误产生的原因，那么这里的多个SPN属性我们是否能够控制，还是说我们已经没有办法实现DNS主机名的更改了呢，我们看一下<code>robert</code>用户对<code>robertpc$</code>的ACL</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410163153.png" alt="微信截图_20250410163153"></p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/win32/adschema/r-validated-spn">Validated-SPN validated writes</a>这个权限描述为用于设置符合计算机DNS主机名的SPN属性，和上面的已验证的到DNS主机名的写入权限类似，我们的<code>servicePrincipalName</code>更新的值也必须符合 <code>dNSHostName</code> 属性，刚才我们注意到我们的四个SPN中只有两个发生了改变，另外两个中并没有包含 <code>dNSHostName</code> ，是不是我们将会发生改变的两个SPN删去后就可以正常进行 <code>dNSHostName</code> 的伪造了？</p>
<p>删去两个变化的SPN</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410163811.png" alt="微信截图_20250410163811"></p>
<p>修改DNS主机名</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410163913.png" alt="微信截图_20250410163913"></p>
<p>我们尝试利用<code>Machine</code>模板申请证书，如下图成功申请</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410164211.png" alt="微信截图_20250410164211"></p>
<p>继续尝试看其能否利用DC进行身份验证，成功</p>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410164411.png" alt="微信截图_20250410164411"></p>
<p>接下来利用DC哈希执行DCSync攻击转储域控上存储的所有用户哈希</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump <span class="string">&#x27;chromos2me.com/dc$@dc.chromos2me.com&#x27;</span> -hashes aad3b435b51404eeaad3b435b51404ee:a9edd7fbef42767175d43643ae7fcfc7 -target-ip 192.168.103.201</span><br></pre></td></tr></table></figure>
<p><img src="/2025/04/11/CVE-2022%E2%80%9326923%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/微信截图_20250410165324.png" alt="微信截图_20250410165324"></p>
<h2 id="证书映射过程"><a href="#证书映射过程" class="headerlink" title="证书映射过程"></a>证书映射过程</h2><p>在Oliver Lyak的文章中还提到了在身份验证期间证书如何映射到帐户的技术细节，在此也简单的说一说</p>
<p>首先根据在AS-REQ中指出的形如<code>user@chromos2me.com</code>的主体名称查找对应的用户，Key Distribution Center（KDC）接着根据账户的userAccountControl 属性，选择不同的映射方式，这里的userAccountControl在我们刚才的机器账户上为4096也就是0x1000，对应<code>WORKSTATION_TRUST_ACCOUNT</code>即计算机账户，另外域控制器账户的掩码值为0x2000对应<code>SERVER_TRUST_ACCOUNT</code>，普通用户账户的掩码值为0x0400对应<code>NORMAL_ACCOUNT</code>，根据不同的账户KDC会通过证书中的SAN字段中的 DNSName 或 UPNName 来验证证书映射，对于上面的三种用户，除了普通账户使用UPNName 字段进行验证外，其他均使用DNSName 字段进行验证</p>
<p>来自<a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pkca/4ab93c65-0e57-4370-9d63-b90521041892">3.1.5.2.1.1 SAN DNSName field</a>的微软文档指出<strong>KDC 必须确认找到的账户名称与证书中 DNSName 字段中的计算机名（以 $ 结尾）匹配，并且证书中 DNSName 字段中的 DNS 域名与 realm 的 DNS 域名匹配</strong></p>
<p>就拿我们做实验的例子来说，我们的计算机账户<code>robertpc$</code>，它属于<code>chromos2me.com</code>，我们为了实现有效的映射，证书中的DNSName应为<code>robertpc.chromos2me.com</code>，即格式为&lt;计算机名&gt;.&lt;域名&gt;，同时这里的 &lt;计算机名&gt; 是sAMAccountName去掉结尾$后的内容</p>
<p>因此，在 PKINIT Kerberos认证过程中，我们提供的主体名称是类似 <code>robertpc$@chromos2me.com</code> 的格式，并提供一个 DNSName 设置为 <code>robertpc.chromos2me.com</code> 的证书。KDC 会根据主体名称查找对应账户。由于 <code>robertpc$</code> 是一个计算机账户，KDC 会将 DNSName 字段分为计算机名部分和域部分。然后 KDC 会验证计算机名部分是否与 sAMAccountName 加上 $ 后一致，并验证域名部分是否与域名匹配。如果两个部分都匹配，验证就成功了，映射也就成立。<strong>值得注意的是，账户的 dNSHostName 属性并不会用于证书映射，该属性仅在申请证书时使用。</strong></p>
<h2 id="修补"><a href="#修补" class="headerlink" title="修补"></a>修补</h2><p>该漏洞已通过 Microsoft 2022 年 5 月的安全更新修复，在证书中引入了一个新的对象标识符，通过将用户的SID嵌入到新的 szOID_NTDS_CA_SECURITY_EXT（1.3.6.1.4.1.311.25.2）OID 中，但是具有新<code>CT_FLAG_NO_SECURITY_EXTENSION（0x80000）</code>标志的证书模板将不会嵌入新<code>szOID_NTDS_CA_SECURITY_EXT OID</code>，因此这些模板仍然容易受到此攻击，虽然这种标志设置的可能性不大。</p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Chromos2me, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/ADCS/" class="tag">#ADCS</a><a href="/tags/域内提权/" class="tag">#域内提权</a><a href="/tags/Windows域安全/" class="tag">#Windows域安全</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2025/04/23/HTB-CrownJewel-2/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">HTB-CrownJewel-2</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2025/03/08/OpSalwarKameez24-1/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">HTB-OpSalwarKameez24-1 Super-Star</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/Chromos2me" class="item">GitHub</a>
                
                <a href="3079749425@qq.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Chromos2me<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>